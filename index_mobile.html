<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>G-CARD Directeor_v2.1</title>
<style>
  *{box-sizing:border-box;}
  html,body{margin:0;width:100%;min-height:100%;overflow:auto;background:#181818;font-family:sans-serif;}
  :root{--ui-bg:#000a;--ui-fg:#eee;--zone-border:#00bfff88;--zone-fill:#00bfff14;--card-w:180px; --set-thumb-w:clamp(130px,18vw,220px); --set-thumb-aspect:21/11;}
  #board{position:relative;width:100vw;height:100vh;background:#222 url("playmat.png") center/cover no-repeat;overflow:hidden;}
  #toolbar{position:absolute;top:8px;left:8px;z-index:2000;background:var(--ui-bg);color:var(--ui-fg);padding:6px 10px;border-radius:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:13px;backdrop-filter:blur(4px);}    
  #toolbar button,#toolbar label{cursor:pointer;border:none;background:#333;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;}#toolbar button:hover,#toolbar label:hover{background:#555;}
  #toolbar select{background:#111;color:#fff;border:1px solid #555;border-radius:4px;padding:2px 4px;}
  #fileInput,#backInput{display:none;}
  .zone{position:absolute;border:2px dashed var(--zone-border);background:var(--zone-fill);color:#bdeaff;font-size:12px;padding:2px 4px;pointer-events:none;}
  .zone-label{position:absolute;top:-16px;left:0;font-weight:bold;text-shadow:0 0 3px #000;}
  .zoneUI{position:absolute;right:4px;bottom:4px;display:flex;gap:4px;pointer-events:auto;}
  .zoneUI button{background:#000c;color:#fff;border:1px solid #555;font-size:11px;padding:2px 6px;border-radius:4px;cursor:pointer;}
  .areaUI{position:absolute;top:-20px;left:50%;transform:translateX(-50%);display:flex;gap:4px;pointer-events:auto;}
  .areaUI button{background:#000c;color:#fff;border:1px solid #555;font-size:10px;padding:1px 4px;border-radius:4px;cursor:pointer;}
  .rageUI{position:absolute;inset:0;pointer-events:auto;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px;}
  #rageCounter{background:#000c;color:#fff;border:2px solid #555;font-size:42px;font-weight:700;padding:6px 14px;border-radius:10px;min-width:72px;text-align:center;text-shadow:0 0 6px #000;}
  .rageBtns{display:flex;gap:6px;}
  .rageBtns button{background:#000c;color:#fff;border:1px solid #555;font-size:12px;padding:3px 10px;border-radius:4px;cursor:pointer;}
  .card{position:absolute;width:var(--card-w);user-select:none;touch-action:none;border-radius:6px;box-shadow:0 2px 4px #000a;transition:box-shadow .12s ease;}
  .card.active{box-shadow:0 0 10px #00bfff;}
  .card.selected{outline:3px solid #ff0;}
  .hidden{display:none !important;}
  #deckCounter,#discardCounter,#monsterCounter{position:absolute;z-index:2100;color:#fff;font-size:18px;font-weight:bold;text-shadow:0 0 6px #000;background:#0007;padding:2px 6px;border-radius:4px;pointer-events:none;}
  /* viewer */
  #viewer.hidden{display:none;}#viewer{position:fixed;inset:0;z-index:4000;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;}
  #viewerPanel{position:relative;width:80vw;height:80vh;background:#222;color:#eee;border-radius:10px;box-shadow:0 0 20px #000;padding:12px 16px;display:flex;flex-direction:column;}
  #viewerPanel h2{margin:0 0 8px;font-size:18px;}#viewerSearch{margin-bottom:8px;padding:4px 6px;width:220px;background:#111;color:#eee;border:1px solid #444;border-radius:4px;font-size:13px;}
  #viewerGrid{flex:1;overflow:auto;display:flex;flex-wrap:wrap;gap:6px;padding:4px;}
  .thumbWrap{position:relative;cursor:pointer;}
  .thumbWrap img{width:100px;border-radius:6px;box-shadow:0 2px 4px #000a;border:2px solid transparent;}
  .thumbWrap.selected img{border-color:#ff0;}
  .thumbName{position:absolute;bottom:2px;right:4px;background:#000a;color:#fff;font-size:11px;padding:1px 4px;border-radius:3px;}
  #viewerBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}#viewerBtns button{background:#444;border:none;color:#fff;padding:6px 12px;border-radius:5px;font-size:13px;cursor:pointer;}#viewerBtns button:hover{background:#666;}
  /* start modal */
  #startModal{position:fixed;inset:0;z-index:4500;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;}
  #startBox{background:#222;color:#eee;padding:24px 32px;border-radius:12px;box-shadow:0 0 20px #000;min-width:320px;text-align:center;}
  #startBox h1{margin:0 0 16px;font-size:22px;}
  #startBox button{margin:6px 0;padding:10px 16px;font-size:15px;background:#444;border:1px solid #666;border-radius:6px;color:#fff;cursor:pointer;width:100%;}
  #startBox button:hover{background:#666;}
  /* deck builder */
  #builder.hidden{display:none;}#builder{position:fixed;inset:0;z-index:4600;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;}
  #builderPanel{position:relative;width:92vw;height:92vh;background:#222;color:#eee;border-radius:10px;box-shadow:0 0 20px #000;padding:12px 16px;display:flex;flex-direction:column;}
  #builderMain{flex:1;display:flex;gap:12px;overflow:hidden;}
  #libPane{flex:1.2;display:flex;flex-direction:column;min-width:0;}
  #deckPane{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
  #libFilter{padding:4px 6px;width:100%;background:#111;color:#eee;border:1px solid #444;border-radius:4px;font-size:13px;margin-bottom:6px;}
  
  /* set / pack filter (deck builder) */
  #libSetBar{
    display:flex;
    gap:10px;
    flex-wrap:nowrap;
    align-items:stretch;
    overflow-x:auto;
    padding:2px 2px 10px;
    margin:0 0 10px 0;
    scroll-snap-type:x proximity;
  }
  #libSetBar::-webkit-scrollbar{height:10px;}
  #libSetBar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:999px;}
  #libSetBar::-webkit-scrollbar-track{background:rgba(0,0,0,.25);border-radius:999px;}

  /* collapsible wrapper for set bar */
  .setSection{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    border-radius:12px;
    padding:8px 10px;
    margin:0 0 10px 0;
  }
  .setHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    cursor:pointer;
    user-select:none;
    padding:2px 2px;
  }
  .setHeader:focus{outline:2px solid rgba(0,191,255,.65);outline-offset:2px;border-radius:10px;}
  .setHeaderLeft{display:flex;align-items:baseline;gap:8px;min-width:0;}
  .setHeaderTitle{font-size:12px;opacity:.9;letter-spacing:.06em;white-space:nowrap;}
  .setHeaderCurrent{
    font-size:12px;
    opacity:.95;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.25);
    max-width:220px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .setToggle{
    width:30px;height:30px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.15);
    color:#fff;
    cursor:pointer;
    display:grid;
    place-items:center;
    padding:0;
    transition:transform .15s ease;
  }
  #libSetBarWrap{
    margin-top:8px;
    overflow:hidden;
    max-height:600px;
    opacity:1;
    transition:max-height .18s ease, opacity .18s ease, margin .18s ease;
  }
  .setSection.collapsed #libSetBarWrap{
    max-height:0;
    opacity:0;
    margin-top:0;
  }
  .setSection.collapsed .setToggle{transform:rotate(-90deg);}

  #libSetBar .setBtn{
    cursor:pointer;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.35);
    color:#fff;
    border-radius:16px;
    padding:10px 10px 8px;
    font-size:12px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    gap:8px;
    min-width: calc(var(--set-thumb-w) + 20px);
    box-shadow: 0 10px 22px rgba(0,0,0,.32);
    scroll-snap-align:start;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  }
  #libSetBar .setBtn:hover{ filter:brightness(1.08); transform: translateY(-1px); }
  #libSetBar .setBtn:active{ transform: translateY(0) scale(.99); }
  #libSetBar .setBtn.active{
    outline:3px solid rgba(45,212,255,.72);
    outline-offset:1px;
    box-shadow: 0 0 0 1px rgba(45,212,255,.22), 0 14px 30px rgba(0,0,0,.38);
  }
  #libSetBar .setBtn img{
    width: var(--set-thumb-w);
    aspect-ratio: 21 / 11;
    height: auto;
    object-fit: cover;
    border-radius: 12px;
    display:block;
    border:1px solid rgba(255,255,255,.10);
  }
  #libSetBar .setBtn .setLabel{
    font-weight:800;
    letter-spacing:.02em;
    user-select:none;
    white-space:nowrap;
    line-height:1.05;
    opacity:.92;
  }
  #libSetBar .setBtn.all{
    min-width: 110px;
    padding:10px 12px;
    justify-content:center;
  }

#libList{flex:1;overflow:auto;display:flex;flex-wrap:wrap;gap:8px;padding:4px;background:#1113;border:1px solid #444;border-radius:4px;}
  .libCard{width:120px;cursor:pointer;position:relative;}
  .libCard img{width:100%;border-radius:6px;box-shadow:0 2px 4px #000a;}
  .libBtns{position:absolute;bottom:4px;left:4px;display:flex;gap:4px;}
  .libBtns button{background:#000b;color:#fff;border:1px solid #666;font-size:11px;padding:2px 4px;border-radius:4px;cursor:pointer;}
  #deckScroll{flex:1;overflow:auto;border:1px solid #444;border-radius:4px;padding:6px;background:#1113;display:flex;flex-direction:column;gap:12px;}
  .deckGroup{border:1px solid #444;border-radius:6px;padding:6px;background:#0004;}
  .deckGroup h4{margin:0 0 6px;font-size:15px;}
  .deckGrid{display:flex;flex-wrap:wrap;gap:6px;}
  .deckThumb{position:relative;width:90px;}
  .deckThumb img{width:100%;border-radius:6px;box-shadow:0 2px 4px #000a;}
  .deckCnt{position:absolute;top:2px;left:2px;background:#000c;color:#fff;font-size:11px;padding:1px 4px;border-radius:3px;}
  .deckThumb .ctrl{position:absolute;bottom:2px;right:2px;display:flex;gap:2px;}
  .deckThumb .ctrl button{background:#000b;color:#fff;border:1px solid #666;font-size:10px;padding:0 4px;border-radius:3px;cursor:pointer;}
  #builderFooter{margin-top:10px;display:flex;justify-content:flex-start;align-items:flex-start;gap:10px;flex-wrap:wrap;}
  #builderFooter textarea{flex:1 1 320px;width:auto;min-width:260px;height:54px;background:#000;color:#eee;border:1px solid #555;border-radius:4px;padding:4px;font-size:11px;}
  #builderFooter button{background:#444;border:1px solid #666;color:#fff;border-radius:6px;padding:6px 12px;cursor:pointer;}
  #builderFooter button:hover{background:#666;}

  .builderBtnCol{display:flex;flex-direction:row;flex-wrap:wrap;gap:6px;min-width:240px;flex:1 1 340px;justify-content:flex-end;align-items:center;}
  .builderBtnCol button,.builderBtnCol .btnLike{white-space:nowrap;}
  .builderSep{flex-basis:100%;width:100%;height:1px;background:rgba(255,255,255,.12);margin:6px 0;}
  .btnLike{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:#444;border:1px solid #666;color:#fff;border-radius:6px;padding:6px 12px;cursor:pointer;user-select:none;}
  .btnLike:hover{background:#666;}
  .btnLike input{display:none;}

  /* deck manager */
  #deckMgr.hidden{display:none;}
  #deckMgr{position:fixed;inset:0;z-index:5200;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:16px;}
  #deckMgrPanel{width:min(920px,92vw);height:min(620px,86vh);background:#111;border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);display:flex;flex-direction:column;overflow:hidden;}
  #deckMgrHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);}
  #deckMgrHeader h2{margin:0;font-size:18px;}
  .deckMgrRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
  #deckMgrHeader input{width:min(320px,60vw);background:#000;border:1px solid #555;color:#fff;border-radius:10px;padding:8px 10px;font-size:13px;}
  #deckMgrList{padding:12px 14px;overflow:auto;display:flex;flex-direction:column;gap:10px;}
  .deckItem{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:12px;}
  .deckMeta{display:flex;flex-direction:column;gap:4px;min-width:0;}
  .deckName{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .deckInfo{opacity:.8;font-size:12px;}
  .deckActions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
  .deckActions button{background:#444;border:1px solid #666;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px;}
  .deckActions button:hover{background:#666;}
  #deckMgrFooter{padding:10px 14px;border-top:1px solid rgba(255,255,255,.10);display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap;}
  #deckMgrFooter .hint{margin-right:auto;opacity:.75;font-size:12px;}
  #countInfo{font-size:13px;}
  /* preview */
  #preview.hidden{display:none;}#preview{position:fixed;inset:0;z-index:5000;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;}
  /* Spaceæ‹¡å¤§è¡¨ç¤ºï¼šç”»åƒã®å®Ÿãƒ•ã‚¡ã‚¤ãƒ«è§£åƒåº¦ã«å·¦å³ã•ã‚Œãªã„â€œæ¨™æº–ã‚µã‚¤ã‚ºâ€ã«çµ±ä¸€ï¼ˆåŸºæº– 460Ã—642ï¼‰ */
  #previewPanel{
    position:relative;
    width:min(90vw, calc(90vh * 460 / 642));
    height:min(90vh, calc(90vw * 642 / 460));
    display:flex;align-items:center;justify-content:center;
  }
  #previewImg{
    width:100%;
    height:100%;
    object-fit:contain;
    border-radius:12px;
    box-shadow:0 0 20px #000;
    background:transparent;
  }
  #previewClose{position:absolute;top:-32px;right:-32px;background:#000c;color:#fff;border:1px solid #666;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:18px;}
  /* token selector */
  #token.hidden{display:none;}#token{position:fixed;inset:0;z-index:4700;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #tokenPanel{position:relative;width:820px;max-width:95vw;max-height:90vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:16px 18px;display:flex;flex-direction:column;gap:10px;}
  #tokenPanel h2{margin:0 0 8px;font-size:20px;}
  #tokenGrid{display:flex;gap:12px;flex-wrap:wrap;overflow:auto;padding:4px;}
  .tokenThumb{position:relative;cursor:pointer;}
  .tokenThumb img{width:140px;border-radius:8px;box-shadow:0 2px 6px #000a;border:3px solid transparent;}
  .tokenName{position:absolute;bottom:4px;right:6px;background:#000a;color:#fff;font-size:12px;padding:2px 6px;border-radius:4px;}
  .tokenThumb.selected img{border-color:#ff0;}
  #tokenFooter{display:flex;gap:10px;justify-content:flex-end;align-items:center;}
  #tokenCount{width:100px;background:#111;color:#eee;border:1px solid #444;border-radius:6px;padding:6px 8px;font-size:14px;}

  /* stack (area overlap) */
  #stack.hidden{display:none;}
  #stack{position:fixed;inset:0;z-index:4750;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #stackPanel{position:relative;width:760px;max-width:95vw;max-height:88vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:14px 16px;display:flex;flex-direction:column;gap:10px;}
  #stackPanel h2{margin:0;font-size:18px;}
  #stackHelp{font-size:12px;opacity:.85;}
  #stackList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:2px;}
  .stackRow{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#111;border:1px solid #333;border-radius:10px;cursor:pointer;}
  .stackRow.selected{outline:2px solid #ff0;}
  .stackThumb{position:relative;}
  .stackThumb img{width:90px;border-radius:8px;box-shadow:0 2px 6px #000a;}
  .stackBadge{position:absolute;top:6px;left:6px;background:#000a;color:#fff;font-size:11px;padding:1px 6px;border-radius:999px;}
  .stackInfo{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px;}
  .stackName{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .stackMeta{font-size:11px;opacity:.75;}
  .stackCtrl{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
  .stackCtrl button{background:#444;border:none;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;}
  .stackCtrl button:hover{background:#666;}
  #stackFooter{display:flex;gap:8px;justify-content:flex-end;}
  #stackFooter button{background:#444;border:none;color:#fff;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer;}
  #stackFooter button:hover{background:#666;}
  /* reveal (deck top ê³µê°œ) */
  #reveal.hidden{display:none;}
  #reveal{position:fixed;inset:0;z-index:4800;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #revealPanel{position:relative;width:760px;max-width:95vw;max-height:88vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:14px 16px;display:flex;flex-direction:column;gap:10px;}
  #revealPanel h2{margin:0;font-size:18px;}
  #revealHelp{font-size:12px;opacity:.85;}
  #revealList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:2px;}
  .revealRow{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#111;border:1px solid #333;border-radius:10px;cursor:pointer;}
  .revealRow.selected{outline:2px solid #ff0;}
  .revealThumb img{width:90px;border-radius:8px;box-shadow:0 2px 6px #000a;}
  .revealInfo{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px;}
  .revealName{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .revealMeta{font-size:11px;opacity:.75;}
  .revealCtrl{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
  .revealCtrl button{background:#444;border:none;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;}
  .revealCtrl button:hover{background:#666;}
  #revealFooter{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;}
  #revealFooter button{background:#444;border:none;color:#fff;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer;}
  #revealFooter button:hover{background:#666;}



  /* ===== Action Log ===== */
  #log.hidden{display:none;}
  #log{position:fixed;inset:0;z-index:4600;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;}
  #logPanel{position:relative;width:80vw;height:80vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:12px 16px;display:flex;flex-direction:column;}
  #logHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;}
  #logHeader h2{margin:0;font-size:18px;}
  #logSearch{flex:1;min-width:160px;background:#111;color:#eee;border:1px solid #444;border-radius:6px;padding:6px 8px;font-size:13px;}
  #logList{flex:1;overflow:auto;background:#111;border:1px solid #444;border-radius:8px;padding:8px;font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;line-height:1.45;}
  #logBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}
  #logBtns button{border:none;background:#555;color:#fff;padding:6px 10px;border-radius:6px;font-size:13px;cursor:pointer;}
  #logBtns button:hover{background:#666;}


  /* ===== Spectator (Discordå…±æœ‰) ===== */
  #spectatorBadge{
    position:fixed; top:8px; right:8px; z-index:9999;
    background:#000c; color:#fff; padding:6px 10px; border-radius:10px;
    font-size:13px; display:none; user-select:none;
  }
  body.spectator #spectatorBadge{ display:block; }
  body.spectator #toolbar{ display:none !important; }
  body.spectator #viewer{ display:none; } /* å±±æœ­ã‚µãƒ¼ãƒä¸€è¦§ã¯éè¡¨ç¤ºï¼ˆå…±æœ‰ç”»é¢ã«ã¯å‡ºã•ãªã„ï¼‰ */
  body.spectator.showDiscardViewer #viewer{ display:flex; } /* æ¨ã¦æœ­ä¸€è¦§ã¯å…±æœ‰OK */
  body.spectator.showDiscardViewer #viewerSearch{ display:none !important; }
  body.spectator.showDiscardViewer #viewerBtns{ display:none !important; }

  #spectatorPickPanel{
    position:fixed; top:8px; left:8px; z-index:9999;
    background:#000c; color:#fff; padding:8px 10px; border-radius:12px;
    display:flex; align-items:center; gap:10px; user-select:none;
    max-width:420px;
  }
  #spectatorPickPanel img{ width:140px; border-radius:10px; box-shadow:0 0 12px #000; }
  #spectatorPickPanel .title{ font-weight:700; font-size:13px; line-height:1.1; }
  #spectatorPickPanel .sub{ font-size:12px; opacity:.9; }

  body.spectator #builder{ display:none !important; }
  body.spectator #startModal{ display:none !important; }
  body.spectator #board{ pointer-events:none; } /* èª¤æ“ä½œé˜²æ­¢ */



/* =========================================================
   UI Redesign Pack (v3.1) â€” 2025-12-17
   ç›®çš„ï¼šè¦‹ãŸç›®ã‚’ã€Œå˜èª¿â†’ç· ã¾ã£ãŸã‚²ãƒ¼ãƒ UIã€ã¸ï¼ˆæ©Ÿèƒ½ã¯ãã®ã¾ã¾ï¼‰
   ========================================================= */

:root{
  --bg0:#0b0d12;
  --bg1:#0f131b;
  --panel:rgba(18,22,30,.72);
  --panelSolid:rgba(18,22,30,.92);
  --panelEdge:rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted:#a8b3c9;

  --accent:#2dd4ff;        /* cyan */
  --accent2:#a78bfa;       /* violet */
  --danger:#ff4d5a;
  --warn:#ffcc66;
  --success:#22c55e;

  --shadow:0 18px 45px rgba(0,0,0,.55);
  --shadowSoft:0 8px 20px rgba(0,0,0,.35);

  --radius:18px;
  --radiusSm:12px;
  --pill:999px;

  --ui-bg:var(--panel);
  --ui-fg:var(--text);
  --zone-border:rgba(45,212,255,.42);
  --zone-fill:rgba(45,212,255,.09);
}

/* base */
html,body{
  background: radial-gradient(1200px 900px at 15% 10%, rgba(167,139,250,.14), transparent 60%),
              radial-gradient(1200px 900px at 85% 45%, rgba(45,212,255,.12), transparent 60%),
              linear-gradient(180deg, var(--bg1), var(--bg0));
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Sans", "Yu Gothic UI", "Meiryo", sans-serif;
}

/* board overlay (ä¸Šã«è¢«ã•ã‚‰ãªã„ã‚ˆã†ã«) */
#board{ background-color:#0b0d12; isolation:isolate; }
#board::before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(167,139,250,.16), transparent 60%),
    radial-gradient(900px 600px at 80% 40%, rgba(45,212,255,.14), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.35));
  pointer-events:none;
  z-index:0;
}
#board .zone, #board .card{ z-index:1; }

/* toolbar */
#toolbar{
  border-radius:var(--radius);
  padding:10px 12px;
  background: var(--panel);
  border:1px solid var(--panelEdge);
  box-shadow: var(--shadowSoft);
  backdrop-filter: blur(12px) saturate(140%);
  gap:10px;
  font-size:12px;
}

/* common button look */
#toolbar button,
#toolbar label,
.zoneUI button,
.areaUI button,
.rageBtns button,
#viewerBtns button,
#builderFooter button,
#tokenFooter button,
#stackFooter button,
.stackCtrl button,
.revealCtrl button,
#revealFooter button,
#logBtns button,
#startBox button{
  border-radius: var(--pill);
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
  color:var(--text);
  box-shadow: 0 6px 16px rgba(0,0,0,.28);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
  letter-spacing:.01em;
}

#toolbar button,
#toolbar label{ padding:7px 12px; display:inline-flex; align-items:center; gap:6px; }
#toolbar button:hover,
#toolbar label:hover{ transform: translateY(-1px); filter: brightness(1.05); border-color: rgba(255,255,255,.22); }
#toolbar button:active,
#toolbar label:active{ transform: translateY(0) scale(.98); box-shadow: 0 4px 12px rgba(0,0,0,.22); }
#toolbar button:focus-visible,
#toolbar label:focus-visible{ outline:2px solid rgba(45,212,255,.55); outline-offset:2px; }

#toolbar select{
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius: var(--pill);
  padding:6px 10px;
}

/* highlight key actions */
#btnRemove{
  background: linear-gradient(180deg, rgba(255,77,90,.95), rgba(185,18,32,.92)) !important;
  border-color: rgba(255,140,150,.35) !important;
}
#btnTurnStart{
  background: linear-gradient(180deg, rgba(45,212,255,.30), rgba(32,96,255,.30)) !important;
  border-color: rgba(45,212,255,.30) !important;
}
#btnOpenSpectator{
  background: linear-gradient(180deg, rgba(34,197,94,.30), rgba(45,212,255,.22)) !important;
  border-color: rgba(34,197,94,.30) !important;
}
#btnSave{
  background: linear-gradient(180deg, rgba(255,204,102,.26), rgba(255,255,255,.06)) !important;
  border-color: rgba(255,204,102,.22) !important;
}

/* zones */
.zone{
  border:1px solid var(--zone-border) !important;
  border-style: solid !important;
  border-radius: 16px;
  background: linear-gradient(180deg, rgba(45,212,255,.10), rgba(45,212,255,.04)) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
  padding:0 !important;
  overflow: visible;
}
.zone-label{
  top:8px !important;
  left:8px !important;
  font-weight:700;
  font-size:12px;
  color: rgba(234,240,255,.95);
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  padding:4px 8px;
  border-radius: var(--pill);
  backdrop-filter: blur(8px);
  text-shadow:none !important;
}

/* slot 1-8 labels outside the frame */
.zone.slot-zone .zone-label{
  top:-26px !important;
  left:50% !important;
  transform:translateX(-50%) !important;
}

/* zone buttons */
.zoneUI{ right:8px !important; bottom:8px !important; gap:6px !important; }
.zoneUI button,
.areaUI button,
.rageBtns button{
  font-size:11px !important;
  padding:6px 10px !important;
  border-radius: var(--pill) !important;
  background: rgba(0,0,0,.45) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  box-shadow: 0 10px 18px rgba(0,0,0,.30) !important;
}
.zoneUI button:hover,
.areaUI button:hover,
.rageBtns button:hover{ filter: brightness(1.06); transform: translateY(-1px); }

/* areaUI position tweak (outside the frame) */
.areaUI{
  top:-34px !important;
  left:auto !important;
  right:0px !important;
  transform:none !important;
  gap:6px !important;
}

/* counters */
#deckCounter,#discardCounter,#monsterCounter{
  border-radius: var(--pill) !important;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.35) !important;
  padding:6px 10px !important;
  font-size:14px !important;
  box-shadow: 0 10px 18px rgba(0,0,0,.28);
}

/* cards */
.card{
  border-radius: 12px !important;
  box-shadow: 0 14px 28px rgba(0,0,0,.38) !important;
  outline: 1px solid rgba(255,255,255,.06);
  transition: box-shadow .14s ease, transform .14s ease, filter .14s ease;
  will-change: transform;
}
.card.active{
  box-shadow: 0 0 0 2px rgba(45,212,255,.55), 0 18px 40px rgba(0,0,0,.55) !important;
}
.card.selected{
  outline: 2px solid rgba(255, 214, 10, .90) !important;
  box-shadow: 0 0 0 3px rgba(255, 214, 10, .28), 0 18px 40px rgba(0,0,0,.55) !important;
}

/* modals: overlay */
#viewer,#builder,#token,#stack,#reveal,#log,#startModal{
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(167,139,250,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 40%, rgba(45,212,255,.14), transparent 60%),
    rgba(0,0,0,.82) !important;
}

/* modals: panels */
#viewerPanel,#builderPanel,#tokenPanel,#stackPanel,#revealPanel,#logPanel,#startBox{
  background: linear-gradient(180deg, rgba(18,22,30,.94), rgba(10,12,16,.90)) !important;
  border:1px solid rgba(255,255,255,.10) !important;
  border-radius: 20px !important;
  box-shadow: var(--shadow) !important;
}

/* headings */
#viewerPanel h2,
#builderPanel h2,
#tokenPanel h2,
#stackPanel h2,
#revealPanel h2,
#logHeader h2,
#startBox h1{
  letter-spacing:.02em;
}

/* inputs */
#viewerSearch,
#libFilter,
#logSearch,
#tokenCount,
#builderFooter textarea{
  border-radius: 14px !important;
  border:1px solid rgba(255,255,255,.12) !important;
  background: rgba(0,0,0,.35) !important;
  color: var(--text) !important;
  padding:10px 12px !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
#builderFooter textarea{ padding:10px 12px !important; }

/* list containers */
#viewerGrid,#libList,#deckScroll,#logList{
  border-radius: 16px !important;
  border:1px solid rgba(255,255,255,.10) !important;
  background: rgba(0,0,0,.22) !important;
}

/* rows */
.stackRow,.revealRow{
  border-radius: 16px !important;
  border:1px solid rgba(255,255,255,.10) !important;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)) !important;
}
.stackRow:hover,.revealRow:hover{ filter: brightness(1.05); }
.stackRow.selected,.revealRow.selected{
  outline:2px solid rgba(255, 214, 10, .80) !important;
}

/* thumbs */
.thumbWrap img,
.libCard img,
.deckThumb img,
.stackThumb img,
.revealThumb img,
.tokenThumb img{
  outline: 1px solid rgba(255,255,255,.08);
}

/* spectator badge */
#spectatorBadge{
  background: rgba(0,0,0,.40) !important;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: var(--pill) !important;
  box-shadow: var(--shadowSoft) !important;
  backdrop-filter: blur(10px) saturate(140%);
}

/* =========================================================
   Fullscreen Deck Builder
   - ç›¤é¢ãŒé€ã‘ã¦è¦‹ãˆã‚‹/ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå°ã•ã„å•é¡Œã‚’è§£æ¶ˆ
   - æ§‹ç¯‰ç”»é¢ãã®ã‚‚ã®ã‚’ç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤º
   ========================================================= */

/* overlay ìì²´ã‚’ä¸é€æ˜ã«ã—ã¦ç›¤é¢ã‚’è¦‹ã›ãªã„ */
#builder{
  align-items: stretch !important;
  justify-content: stretch !important;
  padding: 0 !important;
  /* é€éãªã—ï¼ˆèƒŒæ™¯ãŒâ€œã†ã£ã™ã‚‰ç›¤é¢â€ã«ãªã‚‰ãªã„ï¼‰ */
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(167,139,250,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 40%, rgba(45,212,255,.14), transparent 60%),
    linear-gradient(180deg, #0f131b, #0b0d12) !important;
}

/* ãƒ‘ãƒãƒ«ã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åŒ– */
#builderPanel{
  width: 100vw !important;
  height: 100vh !important;
  max-width: none !important;
  max-height: none !important;
  border-radius: 0 !important;
  border: none !important;
  box-shadow: none !important;
  margin: 0 !important;
}
#spectatorPickPanel{
  background: rgba(0,0,0,.40) !important;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 18px !important;
  box-shadow: var(--shadowSoft) !important;
  backdrop-filter: blur(10px) saturate(140%);
}

/* scrollbars (Chromium) */
*::-webkit-scrollbar{ width: 10px; height: 10px; }
*::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; border:2px solid rgba(0,0,0,.25); }
*::-webkit-scrollbar-track{ background: rgba(0,0,0,.18); border-radius: 999px; }

@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; }
}



/* ===== Mobile-only overrides (this file is mobile edition) ===== */
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}

/* Let the page scroll */
html,body{
  height:auto !important;
  overflow:auto !important;
}

/* board becomes a tall scroll surface */
#board{
  width:100%;
  height: var(--board-h, 1600px);
  overflow: visible;
  touch-action: manipulation;
}

/* Keep the toolbar off by default; open via ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
#toolbar{
  position: fixed;
  left: 10px;
  right: 10px;
  top: auto;
  bottom: calc(env(safe-area-inset-bottom) + 72px);
  max-height: 45vh;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* Mobile quick bar */
.mobileBar{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10000;
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 10px 10px calc(env(safe-area-inset-bottom) + 10px);
  backdrop-filter: blur(10px);
  background: rgba(10,15,25,.55);
  border-top: 1px solid rgba(255,255,255,.12);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.mobileBar .spacer{ flex: 1 0 auto; }
.mobileBar button{
  flex: 0 0 auto;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  color: #fff;
  font-weight: 700;
  letter-spacing: .02em;
}
body{
  padding-bottom: calc(env(safe-area-inset-bottom) + 84px);
}

/* Smaller zone labels on phone */
.zone-label{
  font-size: 12px;
}
.zoneUI button, .areaUI button, .rageBtns button{
  padding: 6px 10px;
  font-size: 12px;
}

</style>
</head>
<body>
  <div id="toolbar" class="hidden">
    <label>ğŸ“‚ ç”»åƒèª­ã¿è¾¼ã¿<input id="fileInput" type="file" accept="image/*" multiple></label>
    <label>ğŸ‚  è£é¢ç”»åƒ<input id="backInput" type="file" accept="image/*"></label>
    <button id="btnFlip">é¸æŠâ†’è¡¨è£åè»¢</button>
    <button id="btnRemove" style="background:#8b0000;">æ¶ˆæ»…</button>
    <button id="btnToFront">æœ€å‰é¢</button>
    <button id="btnToBack">æœ€å¾Œé¢</button>
    <button id="btnUndo">â†©ï¸Undo</button>
    <button id="btnSave">ğŸ’¾ä¿å­˜</button>
    <button id="btnLoad">ğŸ“¥èª­è¾¼</button>
    <button id="btnOpenSpectator" style="background:#2a8;">ğŸ“ºå…±æœ‰ç”¨(æ‰‹æœ­éè¡¨ç¤º)</button>
    <button id="btnLog">ğŸ“œãƒ­ã‚°</button>
    <button id="btnTurnStart" style="background:#0057b7;">ã‚¿ãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="btnPreview">æ‹¡å¤§è¡¨ç¤º</button>
    <button id="btnToken">ãƒˆãƒ¼ã‚¯ãƒ³</button>
    <button id="btnCoin" title="ã‚³ã‚¤ãƒ³ãƒˆã‚¹ï¼ˆè¡¨/è£ãƒ©ãƒ³ãƒ€ãƒ ï¼‰">ğŸª™ã‚³ã‚¤ãƒ³ãƒˆã‚¹</button>
    <button id="btnPhase" title="ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ" style="background:#553;">ãƒ•ã‚§ãƒ¼ã‚ºï¼šã‚¹ã‚¿ãƒ¼ãƒˆãƒ•ã‚§ã‚¤ã‚º</button>
    <label>æˆ»ã™ä½ç½®
      <select id="deckReturnPos">
        <option value="top">ä¸Š</option>
        <option value="bottom">ä¸‹</option>
      </select>
    </label>
    <button id="btnBackToMode" style="background:#444a;">â—€ ãƒ¢ãƒ¼ãƒ‰é¸æŠã«æˆ»ã‚‹</button>
    <span style="opacity:.6;">Alt+ãƒ›ã‚¤ãƒ¼ãƒ«=æ‹¡å¤§ç¸®å° / R=å·¦å›è»¢ / Shift=è¤‡æ•°ãƒ‰ãƒ©ãƒƒã‚° / Space=æ‹¡å¤§</span>
  </div>

  <div id="spectatorBadge">å…±æœ‰ç”¨ï¼ˆæ‰‹æœ­ / ã‚µãƒ¼ãƒéè¡¨ç¤ºï¼‰</div>
  <div id="spectatorPickPanel" class="hidden">
    <img id="spectatorPickImg" alt="">
    <div>
      <div class="title">ã‚µãƒ¼ãƒé¸æŠä¸­</div>
      <div id="spectatorPickName" class="sub"></div>
    </div>
  </div>



  <div id="board"></div>
  <div id="deckCounter"></div>
  <div id="discardCounter"></div>
  <div id="monsterCounter"></div>

  <!-- start modal -->
  <div id="startModal">
    <div id="startBox">
      <h1>G-CARD Director</h1>
      <button id="btnStartBuild">ãƒ‡ãƒƒã‚­æ§‹ç¯‰ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="btnStartPlay">ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰</button>
    </div>
  </div>

  <!-- deck builder -->
  <div id="builder" class="hidden">
    <div id="builderPanel">
      <h2>ãƒ‡ãƒƒã‚­æ§‹ç¯‰</h2>
      <div id="builderMain">
        <div id="libPane">
          <h3>ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h3>

          <!-- set / pack filter (collapsible) -->
          <div id="libSetSection" class="setSection">
            <div id="libSetHeader" class="setHeader" role="button" tabindex="0" aria-controls="libSetBarWrap" aria-expanded="true">
              <div class="setHeaderLeft">
                <span class="setHeaderTitle">å¼¾ãƒ•ã‚£ãƒ«ã‚¿</span>
                <span class="setHeaderCurrent" id="libSetCurrent">ã™ã¹ã¦</span>
              </div>
              <button id="btnLibSetToggle" type="button" class="setToggle" aria-label="å¼¾ãƒ•ã‚£ãƒ«ã‚¿ã‚’æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹">â–¾</button>
            </div>
            <div id="libSetBarWrap">
              <div id="libSetBar"></div>
            </div>
          </div>

          <input id="libFilter" placeholder="åå‰ã§æ¤œç´¢..." />
          <div id="libList"></div>
        </div>
        <div id="deckPane">
          <h3>ç¾åœ¨ã®ãƒ‡ãƒƒã‚­</h3>
          <div id="deckScroll">
            <div class="deckGroup" id="grpMonster"><h4>æ€ªç£ãƒ‡ãƒƒã‚­</h4><div class="deckGrid" id="gridMonster"></div></div>
            <div class="deckGroup" id="grpMain"><h4>ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚­</h4><div class="deckGrid" id="gridMain"></div></div>
          </div>
        </div>
      </div>
      <div id="builderFooter">
        <div id="countInfo">ãƒ¡ã‚¤ãƒ³ 0/50ã€€æ€ªç£ 0/4</div>
        <textarea id="deckCodeBox" placeholder="ã“ã“ã«ãƒ‡ãƒƒã‚­ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚‹ / ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒå‡ºã‚‹"></textarea>
        <div class="builderBtnCol">
          <button id="btnCodeLoad">ã‚³ãƒ¼ãƒ‰èª­è¾¼</button>
          <button id="btnCodeGen">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
          <button id="btnBuildStart">ã“ã®ãƒ‡ãƒƒã‚­ã§é–‹å§‹</button>
          <button id="btnBuildCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <div class="builderSep"></div>
          <button id="btnDeckSave" title="æ§‹ç¯‰ä¸­ã®ãƒ‡ãƒƒã‚­ã‚’ä¿å­˜ã—ã¦ä¸€è¦§ã«ç™»éŒ²">ğŸ’¾ãƒ‡ãƒƒã‚­ã‚»ãƒ¼ãƒ–</button>
          <button id="btnDeckLoad" title="ä¿å­˜æ¸ˆã¿ãƒ‡ãƒƒã‚­ä¸€è¦§ã‚’é–‹ã">ğŸ“šãƒ‡ãƒƒã‚­ãƒ­ãƒ¼ãƒ‰</button>
          <button id="btnDeckDownload" title="ä¿å­˜æ¸ˆã¿ãƒ‡ãƒƒã‚­ä¸€è¦§(ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿)ã‚’JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ã‚»ãƒ¼ãƒ–DL</button>
          <label class="btnLike" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿(JSON)ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å–ã‚Šè¾¼ã‚€">â¬†ã‚»ãƒ¼ãƒ–UP<input id="deckUploadInput" type="file" accept="application/json,.json"></label>
        </div>
      </div>
    </div>
  </div>

  <!-- deck manager -->
  <div id="deckMgr" class="hidden">
    <div id="deckMgrPanel" role="dialog" aria-modal="true" aria-label="ãƒ‡ãƒƒã‚­ä¸€è¦§">
      <div id="deckMgrHeader">
        <h2>ãƒ‡ãƒƒã‚­ä¸€è¦§</h2>
        <div class="deckMgrRight">
          <input id="deckMgrSearch" type="text" placeholder="åå‰ã§æ¤œç´¢" />
          <button id="btnDeckMgrClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div id="deckMgrList"></div>
      <div id="deckMgrFooter">
        <div class="hint"><span id="deckMgrCount">0</span> ä»¶</div>
        <button id="btnDeckMgrDownload" title="ä¿å­˜æ¸ˆã¿ãƒ‡ãƒƒã‚­ä¸€è¦§(ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿)ã‚’JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ä¸€è¦§DL</button>
      </div>
    </div>
  </div>


  <!-- viewer -->
  <div id="viewer" class="hidden">
    <div id="viewerPanel">
      <h2 id="viewerTitle"></h2>
      <input id="viewerSearch" type="text" placeholder="åå‰ã§ãƒ•ã‚£ãƒ«ã‚¿...">
      <div id="viewerGrid"></div>
      <div id="viewerBtns">
        <button id="btnViewerSelectAll">å…¨é¸æŠ/è§£é™¤</button>
        <button id="btnViewerCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="btnViewerToDiscard" style="display:none;">é¸æŠâ†’æ¨ã¦æœ­ã¸</button>
        <button id="btnViewerToHand">é¸æŠâ†’æ‰‹æœ­ã¸</button>
      </div>
    </div>
  </div>

  <!-- preview -->
  <div id="preview" class="hidden">
    <div id="previewPanel">
      <img id="previewImg" src="" alt="preview">
      <button id="previewClose">Ã—</button>
    </div>
  </div>

  <!-- token selector -->
  <div id="token" class="hidden">
    <div id="tokenPanel">
      <h2>ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é¸æŠ</h2>
      <div id="tokenGrid"></div>
      <div id="tokenFooter">
        <label>æšæ•° <input id="tokenCount" type="number" min="1" max="20" value="1"></label>
        <button id="btnTokenCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="btnTokenCreate">ç”Ÿæˆ</button>
      </div>
    </div>
  </div>


  <!-- stack / overlap manager -->
  <div id="stack" class="hidden">
    <div id="stackPanel">
      <h2 id="stackTitle">é‡ãªã‚Š</h2>
      <div id="stackHelp">ä¸Šï¼ˆæ‰‹å‰ï¼‰ã»ã©ç›¤é¢ã§ä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã€ãƒœã‚¿ãƒ³ã§é †ç•ªã‚’å¤‰æ›´ã§ãã¾ã™ã€‚<br>æŸã‚’ã¾ã¨ã‚ã¦ç§»å‹•ï¼š<b>ã€ŒæŸã‚’ä¸¸ã”ã¨ç§»å‹•ã€</b> ã‹ <b>Alt+ãƒ‰ãƒ©ãƒƒã‚°</b></div>
      <div id="stackList"></div>
      <div id="stackFooter">
        <button id="btnStackMoveAll">æŸã‚’ä¸¸ã”ã¨ç§»å‹•</button>
        <button id="btnStackClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>




  <!-- action log -->
  <div id="log" class="hidden">
    <div id="logPanel" role="dialog" aria-modal="true" aria-label="è¡Œå‹•ãƒ­ã‚°">
      <div id="logHeader">
        <h2>è¡Œå‹•ãƒ­ã‚°</h2>
        <input id="logSearch" placeholder="ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä¾‹: ãƒ‰ãƒ­ãƒ¼ / å…¬é–‹ / ç§»å‹•ï¼‰" />
      </div>
      <div id="logList"></div>
      <div id="logBtns">
        <button id="btnLogCopy">ã‚³ãƒ”ãƒ¼</button>
        <button id="btnLogClear" style="background:#8b0000;">ã‚¯ãƒªã‚¢</button>
        <button id="btnLogClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- reveal / deck top ê³µê°œ -->
  <div id="reveal" class="hidden">
    <div id="revealPanel">
      <h2 id="revealTitle">å±±æœ­ å…¬é–‹</h2>
      <div id="revealHelp">ä¸Šï¼ˆå±±æœ­ã®ä¸Šï¼‰ã»ã©å…ˆã«å¼•ã‹ã‚Œã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã€â–²â–¼ã§é †ç•ªå¤‰æ›´ã§ãã¾ã™ã€‚</div>
      <div id="revealList"></div>
      <div id="revealFooter">
        <button id="btnRevealSelectAll">å…¨é¸æŠ/è§£é™¤</button>
        <button id="btnRevealToHand">é¸æŠâ†’æ‰‹æœ­ã¸</button>
        <button id="btnRevealToDiscard">é¸æŠâ†’æ¨ã¦æœ­ã¸</button>
        <button id="btnRevealReturn">ã“ã®é †ã§å±±æœ­ä¸Šã¸æˆ»ã™</button>
        <button id="btnRevealCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

<script>
/***********************************************
 * v1.33a å¤‰æ›´ç‚¹
 * - æ€ªç£ãƒ‡ãƒƒã‚­ç”Ÿæˆé †ã‚’åè»¢ï¼šãƒ‡ãƒƒã‚­æ§‹ç¯‰ç”»é¢å·¦â†’å³ã®é †ã§ä¸Šã«ãªã‚‹
 * - [patch] æ¶ˆæ»…ãƒœã‚¿ãƒ³ã®è¿½åŠ ï¼ˆé¸æŠã‚«ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
 * - [patch] ãƒ‰ãƒ­ãƒ¼é †åºã‚’ã€Œã‚µãƒ¼ãƒè¡¨ç¤ºã®å·¦ä¸Šã‹ã‚‰ã€= deckPoolå…ˆé ­ã‹ã‚‰ã«å¤‰æ›´
 * - [patch] ç›¤é¢â†’å±±æœ­ã¸æˆ»ã™ä½ç½®ã‚’ã€Œä¸Š/ä¸‹ã€ã‹ã‚‰é¸æŠã§ãã‚‹UIã‚’è¿½åŠ 
 ***********************************************/

// ====== ç”»åƒDBä½œæˆ ======
const CARD_FOLDER = 'ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ';

function rangeIds(prefix, from, to, opts = {}) {
  const { pad = 3, suffix = '' } = opts;
  const arr = [];
  for (let i = from; i <= to; i++) {
    const num = pad ? String(i).padStart(pad, '0') : String(i); // pad=0ãªã‚‰åŸ‹ã‚ãªã„
    arr.push(`${prefix}-${num}${suffix}`);
  }
  return arr;
}


function getSetKeyFromId(id){
  const s = String(id||'');
  // SD{ç¨®é¡(1/2)} ã¯ SD1 / SD2 ã«æ­£è¦åŒ–ï¼ˆSD01/SD02 ã‚‚å¸åï¼‰
  let m = s.match(/^SD0?([12])/);
  if(m) return 'SD' + m[1];

  // BP{æ®µæ•°} ã¯ 2æ¡ã«æ­£è¦åŒ–ï¼ˆBP1 ã‚‚ BP01 ã¸ï¼‰
  m = s.match(/^BP(\d{1,2})/);
  if(m){
    const n = String(parseInt(m[1],10)).padStart(2,'0');
    return 'BP' + n;
  }

  // FC ã¯ 2æ¡ã«æ­£è¦åŒ–
  m = s.match(/^FC(\d{1,2})/);
  if(m){
    const n = String(parseInt(m[1],10)).padStart(2,'0');
    return 'FC' + n;
  }

  if(s.startsWith('PR')) return 'PR';
  return 'OTHER';
}

const IDS = [
  ...rangeIds('SD01', 1, 15, { suffix: 'ol' }),
  ...rangeIds('SD02', 1, 15, { suffix: 'ol' }),
  ...rangeIds('BP01', 1, 80, { suffix: 'ol' }),

  // ol ãªã—ç³»
  ...rangeIds('BP02', 1, 80, { suffix: '' }),
  ...rangeIds('BP03', 1, 80, { suffix: '' }),
  ...rangeIds('FC01', 1, 6, { suffix: '' }), 

  'PR-004',
  'PR-005',
];

const CARD_DB = IDS.map(id => ({
  id,
  name: id,
  set: getSetKeyFromId(id),
  deck: 'main',
  srcGuess: `${CARD_FOLDER}/${id}.png`,
}));

const WHITE_BACK="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO3kqE0AAAAASUVORK5CYII=";
const MAX_DUP_PER_NAME=4,MAX_SAVE_BYTES=4_500_000;const MAIN_LIMIT=50,MON_LIMIT=4;
let backSrc=WHITE_BACK;let rageCount=0;

// DOM refs
const board=document.getElementById('board');
const fileInput=document.getElementById('fileInput');
const backInput=document.getElementById('backInput');
const deckCounterEl=document.getElementById('deckCounter');
const discardCounterEl=document.getElementById('discardCounter');
const monsterCounterEl=document.getElementById('monsterCounter');
const toolbar=document.getElementById('toolbar');
const btnFlip=document.getElementById('btnFlip');
const btnRemove=document.getElementById('btnRemove'); // [patch]
const btnToFront=document.getElementById('btnToFront');
const btnToBack=document.getElementById('btnToBack');
const btnUndo=document.getElementById('btnUndo');
const btnSave=document.getElementById('btnSave');
const btnLoad=document.getElementById('btnLoad');
const btnOpenSpectator=document.getElementById('btnOpenSpectator');

const spectatorPickPanel=document.getElementById('spectatorPickPanel');
const spectatorPickImg=document.getElementById('spectatorPickImg');
const spectatorPickName=document.getElementById('spectatorPickName');

let lastViewerPickedId=null; // å±±æœ­ã‚µãƒ¼ãƒã§æœ€å¾Œã«é¸æŠ/è§£é™¤ã—ãŸã‚«ãƒ¼ãƒ‰


// ===== Spectator (Discordå…±æœ‰) =====
const IS_SPECTATOR = new URLSearchParams(location.search).has('spectator');
if(IS_SPECTATOR) document.body.classList.add('spectator');

// ===== Phase / Coin Toss =====
const PHASES = ['ã‚¹ã‚¿ãƒ¼ãƒˆãƒ•ã‚§ã‚¤ã‚º','ãƒ¡ã‚¤ãƒ³ãƒ•ã‚§ã‚¤ã‚º','æ’ƒé€€ãƒ•ã‚§ã‚¤ã‚º','ã‚¨ãƒ³ãƒ‰ãƒ•ã‚§ã‚¤ã‚º'];
let phaseIndex = 0;
let lastCoin = null;

function updatePhaseUI(){
  try{ if(btnPhase) btnPhase.textContent = `ãƒ•ã‚§ãƒ¼ã‚ºï¼š${PHASES[phaseIndex]}`; }catch(e){}
}
function updateCoinUI(){
  try{
    if(btnCoin){
      btnCoin.textContent = lastCoin ? `ğŸª™ã‚³ã‚¤ãƒ³ãƒˆã‚¹ï¼š${lastCoin}` : 'ğŸª™ã‚³ã‚¤ãƒ³ãƒˆã‚¹';
    }
  }catch(e){}
}
function doCoinToss(){
  if(IS_SPECTATOR) return;
  lastCoin = (Math.random()<0.5) ? 'è¡¨' : 'è£';
  updateCoinUI();
  try{ window.logAction && window.logAction(`ã‚³ã‚¤ãƒ³ãƒˆã‚¹ï¼š${lastCoin}`); }catch(e){}
  try{ if(typeof pushUndo==='function') pushUndo(); }catch(e){}
  try{ if(typeof scheduleSpectatorSyncFast==='function') scheduleSpectatorSyncFast(); }catch(e){}
}
function nextPhase(){
  if(IS_SPECTATOR) return;
  phaseIndex = (phaseIndex + 1) % PHASES.length;
  updatePhaseUI();
  try{ window.logAction && window.logAction(`ãƒ•ã‚§ãƒ¼ã‚ºï¼š${PHASES[phaseIndex]}`); }catch(e){}
  try{ if(typeof pushUndo==='function') pushUndo(); }catch(e){}
  try{ if(typeof scheduleSpectatorSyncFast==='function') scheduleSpectatorSyncFast(); }catch(e){}
}

let spectatorWin = null;
let spectatorSyncTimer = null;

// reveal sync cache (spectator): avoid flicker by skipping redundant rebuilds
let spectatorRevealOpen=false;
let spectatorRevealKey='';
let spectatorRevealLastTs=0;

function spectatorUrl(){
  const u = new URL(location.href);
  u.searchParams.set('spectator','1');
  return u.toString();
}

function openSpectatorWindow(){
  if(IS_SPECTATOR) return;
  const url = spectatorUrl();
  spectatorWin = window.open(url, 'GCardSpectator', 'popup,width=1280,height=720');
  if(!spectatorWin){ alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚'); return; }

  // ãªã‚‹ã¹ããƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«è¿‘ãåŒæœŸï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‚‚è¿½å¾“ã•ã›ã‚‹ï¼‰
  if(spectatorSyncTimer) clearInterval(spectatorSyncTimer);
  spectatorSyncTimer = setInterval(()=>{
    if(!spectatorWin || spectatorWin.closed){
      clearInterval(spectatorSyncTimer);
      spectatorSyncTimer = null;
      spectatorWin = null;
      return;
    }
    sendStateToSpectator();
  }, 200);

  // åˆå›å³é€ä¿¡
  setTimeout(sendStateToSpectator, 200);
}

function sendStateToSpectator(){
  if(IS_SPECTATOR) return;
  if(!spectatorWin || spectatorWin.closed) return;
  try{
    const _st=lightState();_st.__boardW=board?board.clientWidth:0;_st.__boardH=board?board.clientHeight:0;spectatorWin.postMessage({type:'GCARD_SYNC', payload: JSON.stringify(_st), ts:Date.now()}, '*');
  }catch(e){}
  sendRevealToSpectator();
  sendViewerUiToSpectator();
  sendPickToSpectator();
}
function sendRevealToSpectator(){
  if(IS_SPECTATOR) return;
  if(!spectatorWin || spectatorWin.closed) return;
  try{
    spectatorWin.postMessage({type:'GCARD_REVEAL', pool: (Array.isArray(revealPool)?revealPool.slice():[]), open: revealIsOpen(), ts:Date.now()}, '*');
  }catch(e){}
}
function viewerIsOpen(){ try{ return viewer && !viewer.classList.contains('hidden'); }catch(e){ return false; } }

// å…±æœ‰ç”¨UI: æ¨ã¦æœ­ä¸€è¦§ã¯è¡¨ç¤ºã—ã¦OKã€å±±æœ­ä¸€è¦§ã¯NG
function sendViewerUiToSpectator(){
  if(IS_SPECTATOR) return;
  if(!spectatorWin || spectatorWin.closed) return;
  const open = viewerIsOpen();
  const mode = (typeof viewerMode!=='undefined') ? viewerMode : null;
  try{
    spectatorWin.postMessage({type:'GCARD_VIEWER', open, mode, ts:Date.now()}, '*');
  }catch(e){}
}

// å±±æœ­ã‚µãƒ¼ãƒæ™‚ï¼šé¸æŠä¸­ã®ã‚«ãƒ¼ãƒ‰ã ã‘è¦³æˆ¦å´ã«è¦‹ã›ã‚‹
function sendPickToSpectator(){
  if(IS_SPECTATOR) return;
  if(!spectatorWin || spectatorWin.closed) return;
  const open = viewerIsOpen();
  let pick=null;
  try{
    if(open && viewerMode==='deck'){
      const ids=[...viewerSelection];
      const id=(lastViewerPickedId && viewerSelection.has(lastViewerPickedId)) ? lastViewerPickedId : (ids[0]||null);
      if(id){
        const c=state.cards[id];
        if(c) pick={id, name:(c.name||c.id||id), front:(c.front||currentSrc(c))};
        else pick={id, name:id, front:null};
      }
    }
  }catch(e){}
  try{
    spectatorWin.postMessage({type:'GCARD_PICK', open, mode:(typeof viewerMode!=='undefined'?viewerMode:null), pick, ts:Date.now()}, '*');
  }catch(e){}
}

let spectatorFastLast=0;
function scheduleSpectatorSyncFast(){
  if(IS_SPECTATOR) return;
  if(!spectatorWin || spectatorWin.closed) return;
  const now = performance.now();
  if(now - spectatorFastLast < 50) return; // ç´„20fpsã§ååˆ†
  spectatorFastLast = now;
  sendStateToSpectator();
}


// spectatorå´ï¼šopenerã«åŒæœŸè¦æ±‚ + åŒæœŸå—ä¿¡
if(IS_SPECTATOR){
  window.addEventListener('message',(ev)=>{
    const d = ev.data;
    if(!d || typeof d!=='object') return;

    if(d.type==='GCARD_SYNC' && typeof d.payload==='string'){
      let __meta=null;
      try{
        const __p=JSON.parse(d.payload);
        if(__p && typeof __p.__boardW==='number' && typeof __p.__boardH==='number'){
          __meta={w:__p.__boardW,h:__p.__boardH};
        }
      }catch(e){}
      try{ loadFromJSON(d.payload, false); }catch(e){}
      // ãƒ¡ã‚¤ãƒ³ç”»é¢ã¨è¦³æˆ¦ç”»é¢ã§ board ã‚µã‚¤ã‚ºãŒé•ã†ã¨åº§æ¨™ãŒã‚ºãƒ¬ã‚‹ã®ã§ã€æ¯”ç‡ã§è£œæ­£
      try{
        if(__meta && __meta.w>0 && __meta.h>0 && board){
          const __sw=board.clientWidth, __sh=board.clientHeight;
          const __rx=__sw/__meta.w, __ry=__sh/__meta.h;
          if(isFinite(__rx)&&isFinite(__ry)&&__rx>0&&__ry>0){
            Object.values(state.cards).forEach(c=>{
              if(typeof c.x==='number') c.x=c.x*__rx;
              if(typeof c.y==='number') c.y=c.y*__ry;
            });
            state.order.forEach(id=>{
              const c=state.cards[id];
              const el=document.getElementById(id);
              if(!el||!c) return;
              el.style.left=c.x+'px';
              el.style.top=c.y+'px';
              el.style.transform=`scale(${c.scale}) rotate(${c.rot}deg)`;
            });
          }
        }
      }catch(e){}
      // æ¨ã¦æœ­ä¸€è¦§ã‚’è¡¨ç¤ºä¸­ãªã‚‰ã€å†…å®¹ã‚‚è¿½å¾“æ›´æ–°
      try{
        if(document.body.classList.contains('showDiscardViewer')){
          viewerMode='discard';
          if(viewer) viewer.classList.remove('hidden');
          if(viewerTitle) viewerTitle.textContent='æ¨ã¦æœ­ï¼ˆå…¬é–‹ï¼‰';
          buildViewerGrid();
        }
      }catch(e){}
    }

    if(d.type==='GCARD_VIEWER'){
      try{
        const open=!!d.open;
        const mode=d.mode;
        if(open && mode==='discard'){
          document.body.classList.add('showDiscardViewer');
          viewerMode='discard';
          if(viewerTitle) viewerTitle.textContent='æ¨ã¦æœ­ï¼ˆå…¬é–‹ï¼‰';
          if(viewerSearchInput) viewerSearchInput.value='';
          if(viewer) viewer.classList.remove('hidden');
          buildViewerGrid();
        }else{
          document.body.classList.remove('showDiscardViewer');
          if(viewer) viewer.classList.add('hidden');
        }
      }catch(e){}
    }

    if(d.type==='GCARD_PICK'){
      try{
        const open=!!d.open;
        const mode=d.mode;
        const pick=d.pick;
        if(open && mode==='deck' && pick && pick.front){
          if(spectatorPickImg) spectatorPickImg.src=pick.front;
          if(spectatorPickName) spectatorPickName.textContent=pick.name||pick.id||'';
          if(spectatorPickPanel) spectatorPickPanel.classList.remove('hidden');
        }else{
          if(spectatorPickPanel) spectatorPickPanel.classList.add('hidden');
          if(spectatorPickImg) spectatorPickImg.removeAttribute('src');
          if(spectatorPickName) spectatorPickName.textContent='';
        }
      }catch(e){}
    }

    if(d.type==='GCARD_REVEAL'){
      try{
        // å…¬é–‹ã¯è¦‹ãˆã¦OKï¼ˆç›¸æ‰‹ã«ã‚‚è¦‹ã›ã‚‹æƒ³å®šï¼‰
        const ts = (typeof d.ts==='number') ? d.ts : 0;
        if(ts && ts<=spectatorRevealLastTs) return;
        if(ts) spectatorRevealLastTs = ts;

        const open = !!d.open;
        const pool = Array.isArray(d.pool) ? d.pool.slice() : [];
        const key = pool.join('|');

        // close or empty
        if(!open || pool.length===0){
          if(spectatorRevealOpen){
            spectatorRevealOpen=false;
            spectatorRevealKey='';
            if(revealSelection && revealSelection.clear) revealSelection.clear();
            closeRevealModal();
          }
          revealPool=[];
          revealOriginal=[];
          return;
        }

        // open + has cards
        if(!spectatorRevealOpen){
          spectatorRevealOpen=true;
          spectatorRevealKey=key;
          revealPool=pool;
          revealOriginal=pool.slice();
          if(revealSelection && revealSelection.clear) revealSelection.clear();
          // å…±æœ‰ç”»é¢ã¯é »ç¹ãªå†æç”»ã§ãƒãƒ©ã¤ãã®ã§ã€æœ€åˆã ã‘é–‹ãï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãªã„ï¼‰
          showRevealModal(true);
          return;
        }

        // already open: rebuild only when order/content changed
        if(key!==spectatorRevealKey){
          spectatorRevealKey=key;
          revealPool=pool;
          revealOriginal=pool.slice();
          if(revealSelection && revealSelection.clear) revealSelection.clear();
          buildRevealList();
        }
      }catch(e){}
    }
  });
  try{
    if(window.opener) window.opener.postMessage({type:'GCARD_REQ_SYNC'}, '*');
  }catch(e){}
}

// mainå´ï¼šåŒæœŸè¦æ±‚ãŒæ¥ãŸã‚‰é€ã‚‹
window.addEventListener('message',(ev)=>{
  const d = ev.data;
  if(!d || typeof d!=='object') return;
  if(d.type==='GCARD_REQ_SYNC') sendStateToSpectator();
});

const btnTurnStart=document.getElementById('btnTurnStart');
const btnPreview=document.getElementById('btnPreview');
const btnBackToMode=document.getElementById('btnBackToMode');
const btnToken=document.getElementById('btnToken');
const btnCoin=document.getElementById('btnCoin');
const btnPhase=document.getElementById('btnPhase');
const deckReturnPosSel=document.getElementById('deckReturnPos'); // [patch]
let deckReturnPos=deckReturnPosSel?deckReturnPosSel.value:'top'; // [patch]
if(deckReturnPosSel){deckReturnPosSel.onchange=()=>{deckReturnPos=deckReturnPosSel.value;};}

// start modal
const startModal=document.getElementById('startModal');
const btnStartBuild=document.getElementById('btnStartBuild');
const btnStartPlay=document.getElementById('btnStartPlay');

// builder
const builder=document.getElementById('builder');
const libFilter=document.getElementById('libFilter');
const libSetBar=document.getElementById('libSetBar');
const libSetSection=document.getElementById('libSetSection');
const libSetHeader=document.getElementById('libSetHeader');
const btnLibSetToggle=document.getElementById('btnLibSetToggle');
const libSetCurrent=document.getElementById('libSetCurrent');
const libList=document.getElementById('libList');
const gridMonster=document.getElementById('gridMonster');
const gridMain=document.getElementById('gridMain');
const countInfo=document.getElementById('countInfo');
const deckCodeBox=document.getElementById('deckCodeBox');
const btnCodeLoad=document.getElementById('btnCodeLoad');
const btnCodeGen=document.getElementById('btnCodeGen');
const btnBuildStart=document.getElementById('btnBuildStart');
const btnBuildCancel=document.getElementById('btnBuildCancel');

// deck saves (builder)
const btnDeckSave=document.getElementById('btnDeckSave');
const btnDeckLoad=document.getElementById('btnDeckLoad');
const btnDeckDownload=document.getElementById('btnDeckDownload');
const deckUploadInput=document.getElementById('deckUploadInput');
const deckMgr=document.getElementById('deckMgr');
const deckMgrSearch=document.getElementById('deckMgrSearch');
const deckMgrList=document.getElementById('deckMgrList');
const deckMgrCount=document.getElementById('deckMgrCount');
const btnDeckMgrClose=document.getElementById('btnDeckMgrClose');
const btnDeckMgrDownload=document.getElementById('btnDeckMgrDownload');


// stack (area overlap)
const stackModal=document.getElementById('stack');
const stackTitle=document.getElementById('stackTitle');
const stackList=document.getElementById('stackList');
const btnStackClose=document.getElementById('btnStackClose');
const btnStackMoveAll=document.getElementById('btnStackMoveAll');
let stackZoneId=null;
let stackSelectedId=null;

// reveal (deck top ê³µê°œ)
const revealModal=document.getElementById('reveal');
const revealTitle=document.getElementById('revealTitle');
const revealList=document.getElementById('revealList');
const btnRevealSelectAll=document.getElementById('btnRevealSelectAll');
const btnRevealToHand=document.getElementById('btnRevealToHand');
const btnRevealToDiscard=document.getElementById('btnRevealToDiscard');
const btnRevealReturn=document.getElementById('btnRevealReturn');
const btnRevealCancel=document.getElementById('btnRevealCancel');
let revealPool=[];
let revealOriginal=[];
let revealSelection=new Set();
let revealTxnSnap=null;
let revealUndoMark=null;


// ===== stack / overlap manager =====
function closeStack(){stackModal.classList.add('hidden');stackZoneId=null;stackSelectedId=null;}
btnStackClose.onclick=closeStack;
btnStackMoveAll.onclick=()=>{
  if(!stackZoneId) return;
  const ids=getZoneCardIds(stackZoneId);
  if(!ids.length) return;
  selection.clear();
  ids.forEach(id=>selection.add(id));
  updateSelectionVisual();
  // ã™ããƒ‰ãƒ©ãƒƒã‚°ã§ãã‚‹ã‚ˆã†ã«é–‰ã˜ã‚‹
  closeStack();
  try{
    const z=zones.find(z=>z.id===stackZoneId);
    const nm=z?z.name:String(stackZoneId||'');
    window.logAction && window.logAction(`æŸã‚’é¸æŠï¼š${nm}ï¼ˆ${ids.length}æšï¼‰`);
  }catch(e){}
};
stackModal.addEventListener('click',e=>{ if(e.target===stackModal) closeStack(); });
stackModal.addEventListener('keydown',e=>{
  if(e.key==='Escape'){e.preventDefault();closeStack();}
});

function getZoneCardIds(zoneId){
  // state.order ã®é †ï¼ˆå¥¥â†’æ‰‹å‰ï¼‰ã§è¿”ã™
  return state.order.filter(id=>state.cards[id] && state.cards[id].zone===zoneId);
}
function syncOrderToDOM(){
  // state.order ã®é †ã«DOMä¸¦ã³ã‚‚æƒãˆã‚‹ï¼ˆè¦‹ãŸç›®ã®é‡ãªã‚Šé †ã«åŠ¹ãï¼‰
  state.order.forEach(id=>{
    const el=document.getElementById(id);
    if(el) board.appendChild(el);
  });
}
function applyZoneOrder(zoneId,newZoneIds){
  const set=new Set(newZoneIds);
  let p=0;
  state.order = state.order.map(id=> set.has(id) ? newZoneIds[p++] : id);
  syncOrderToDOM();
}

function openStack(zoneId){
  stackZoneId=zoneId;
  stackSelectedId=null;
  const z=zones.find(z=>z.id===zoneId);
  stackTitle.textContent = z ? `ã‚¨ãƒªã‚¢${z.name}ï¼šé‡ãªã‚Š` : 'é‡ãªã‚Š';
  buildStackList();
  stackModal.classList.remove('hidden');
  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦Escã‚’æ‹¾ã†
  stackModal.tabIndex = -1;
  stackModal.focus();
}

function selectStackRow(cardId){
  stackSelectedId=cardId;
  // ç›¤é¢ã®é¸æŠã‚‚é€£å‹•
  selection.clear();selection.add(cardId);updateSelectionVisual();
  // è¡Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  stackList.querySelectorAll('.stackRow').forEach(r=>r.classList.toggle('selected',r.dataset.id===cardId));
}

function moveInStack(cardId,delta){
  if(!stackZoneId) return;
  const ids=getZoneCardIds(stackZoneId); // å¥¥â†’æ‰‹å‰
  const idx=ids.indexOf(cardId);
  if(idx===-1) return;
  const to=Math.max(0,Math.min(ids.length-1,idx+delta));
  if(to===idx) return;
  ids.splice(idx,1);
  ids.splice(to,0,cardId);
  applyZoneOrder(stackZoneId,ids);
  buildStackList();
  selectStackRow(cardId);
  if(typeof pushUndoDebounced==='function') pushUndoDebounced();
  else pushUndo();
}

function moveToEdge(cardId,toFront){
  if(!stackZoneId) return;
  const ids=getZoneCardIds(stackZoneId); // å¥¥â†’æ‰‹å‰
  const idx=ids.indexOf(cardId);
  if(idx===-1) return;
  ids.splice(idx,1);
  if(toFront) ids.push(cardId); else ids.unshift(cardId);
  applyZoneOrder(stackZoneId,ids);
  buildStackList();
  selectStackRow(cardId);
  if(typeof pushUndoDebounced==='function') pushUndoDebounced();
  else pushUndo();
}

function buildStackList(){
  stackList.innerHTML='';
  if(!stackZoneId) return;
  const ids=getZoneCardIds(stackZoneId); // å¥¥â†’æ‰‹å‰
  if(!ids.length){
    const p=document.createElement('div');
    p.style.opacity='.8';
    p.textContent='ï¼ˆã“ã®ã‚¨ãƒªã‚¢ã«ã¯ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰';
    stackList.appendChild(p);
    return;
  }

  // è¡¨ç¤ºã¯ã€Œæ‰‹å‰â†’å¥¥ã€ã«ã—ã¦ç›´æ„Ÿçš„ã«
  const display=ids.slice().reverse(); // æ‰‹å‰â†’å¥¥
  display.forEach((id,dispIndex)=>{
    const c=state.cards[id];
    const row=document.createElement('div');
    row.className='stackRow';
    row.dataset.id=id;

    const thumb=document.createElement('div');thumb.className='stackThumb';
    const img=document.createElement('img');
    img.src=c.front; // è£ã§ã‚‚ä¸­èº«ç¢ºèªã§ãã‚‹ã‚ˆã†ã« front ã‚’è¡¨ç¤º
    img.onerror=()=>{img.src=WHITE_BACK;};
    thumb.appendChild(img);
    if(c.faceDown){
      const badge=document.createElement('div');badge.className='stackBadge';badge.textContent='è£';
      thumb.appendChild(badge);
    }

    const info=document.createElement('div');info.className='stackInfo';
    const name=document.createElement('div');name.className='stackName';name.textContent=c.origName || '';
    const meta=document.createElement('div');meta.className='stackMeta';
    meta.textContent = (dispIndex===0?'æ‰‹å‰ï¼ˆæœ€ä¸Šï¼‰':(dispIndex===display.length-1?'å¥¥ï¼ˆæœ€ä¸‹ï¼‰':''));
    info.append(name,meta);

    const ctrl=document.createElement('div');ctrl.className='stackCtrl';
    const btnFront=document.createElement('button');btnFront.textContent='æ‰‹å‰ã¸';
    const btnBack=document.createElement('button');btnBack.textContent='å¥¥ã¸';
    const btnTop=document.createElement('button');btnTop.textContent='æœ€å‰';
    const btnBottom=document.createElement('button');btnBottom.textContent='æœ€å¥¥';

    // display ã¯ æ‰‹å‰â†’å¥¥ã€‚state order(ids) ã¯ å¥¥â†’æ‰‹å‰ ãªã®ã§ã€æ‰‹å‰ã¸ = +1 / å¥¥ã¸ = -1
    btnFront.onclick=(e)=>{e.stopPropagation();moveInStack(id,+1);};
    btnBack.onclick=(e)=>{e.stopPropagation();moveInStack(id,-1);};
    btnTop.onclick=(e)=>{e.stopPropagation();moveToEdge(id,true);};
    btnBottom.onclick=(e)=>{e.stopPropagation();moveToEdge(id,false);};

    ctrl.append(btnFront,btnBack,btnTop,btnBottom);

    row.append(thumb,info,ctrl);
    row.onclick=()=>selectStackRow(id);

    // åˆæœŸã§ä¸€ç•ªæ‰‹å‰ã‚’é¸æŠ
    stackList.appendChild(row);
  });

  if(!stackSelectedId){
    const first=display[0];
    if(first) selectStackRow(first);
  }else{
    // ã¾ã å­˜åœ¨ã—ã¦ã‚‹ãªã‚‰é¸æŠç¶­æŒ
    if(display.includes(stackSelectedId)) selectStackRow(stackSelectedId);
    else stackSelectedId=null;
  }
}

// ===== reveal (deck top ê³µê°œ) =====
function revealIsOpen(){ return revealModal && !revealModal.classList.contains('hidden'); }

function showRevealModal(skipFocus=false){
  if(!revealModal) return;
  buildRevealList();
  revealModal.classList.remove('hidden');
  if(!skipFocus){
    revealModal.tabIndex = -1;
    revealModal.focus();
  }
}
function closeRevealModal(){
  if(!revealModal) return;
  revealModal.classList.add('hidden');
  revealSelection.clear();
}

function openRevealPrompt(){
  if(revealIsOpen()){ alert('ã™ã§ã«å…¬é–‹ä¸­ã§ã™'); return; }
  if(deckPool.length===0){ alert('å±±æœ­ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const raw = prompt('å±±æœ­ã®ä¸Šã‹ã‚‰ä½•æšå…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ', '1');
  if(raw==null) return;
  let n = parseInt(String(raw).trim(),10);
  if(!Number.isFinite(n) || n<=0){ alert('æšæ•°ãŒä¸æ­£ã§ã™'); return; }
  n = Math.min(n, deckPool.length);
  startReveal(n);
}

function startReveal(n){
  // ã™ã§ã«å…¬é–‹ä¸­ãªã‚‰ç„¡è¦–
  if(revealPool.length){ showRevealModal(); return; }

  // å…¬é–‹ã¯ã€Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€æ‰±ã„ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯é–‹å§‹å‰ã¸ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
  revealUndoMark = state.undoStack.length;
  try{ revealTxnSnap = JSON.stringify(lightState()); }catch(e){ revealTxnSnap = null; }

  revealPool = deckPool.splice(0, n); // å±±æœ­ã®ä¸Šã‹ã‚‰å–ã‚Šå‡ºã™
  revealOriginal = revealPool.slice(); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨
  revealSelection.clear();
  updateCounters();
  showRevealModal();
}

function buildRevealList(){
  if(!revealList) return;
  revealList.innerHTML='';
  // ã‚¿ã‚¤ãƒˆãƒ«
  if(revealTitle){
    revealTitle.textContent = `å±±æœ­ å…¬é–‹ï¼ˆ${revealPool.length}æšï¼‰`;
  }
  if(!revealPool.length){
    const p=document.createElement('div');
    p.style.opacity='.8';
    p.textContent='ï¼ˆå…¬é–‹ä¸­ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
    revealList.appendChild(p);
    return;
  }

  revealPool.forEach((id,idx)=>{
    const c=state.cards[id];
    const row=document.createElement('div');
    row.className='revealRow';
    row.dataset.id=id;
    row.classList.toggle('selected', revealSelection.has(id));

    const thumb=document.createElement('div');
    thumb.className='revealThumb';
    const img=document.createElement('img');
    img.src=c.front;
    img.onerror=()=>{img.src=WHITE_BACK;};
    thumb.appendChild(img);

    const info=document.createElement('div');
    info.className='revealInfo';
    const name=document.createElement('div');
    name.className='revealName';
    name.textContent=c.origName||'';
    const meta=document.createElement('div');
    meta.className='revealMeta';
    meta.textContent = (idx===0?'ä¸Šï¼ˆ1æšç›®ï¼‰':`ä¸Šã‹ã‚‰${idx+1}æšç›®`);
    info.append(name,meta);

    const ctrl=document.createElement('div');
    ctrl.className='revealCtrl';
    const up=document.createElement('button');up.textContent='â–²';
    const down=document.createElement('button');down.textContent='â–¼';
    up.disabled = (idx===0);
    down.disabled = (idx===revealPool.length-1);

    up.onclick=(e)=>{e.stopPropagation();moveReveal(id,-1);};
    down.onclick=(e)=>{e.stopPropagation();moveReveal(id,+1);};

    ctrl.append(up,down);

    row.append(thumb,info,ctrl);
    row.onclick=()=>toggleRevealSelect(id);

    revealList.appendChild(row);
  });
}

function toggleRevealSelect(id){
  if(revealSelection.has(id)) revealSelection.delete(id);
  else revealSelection.add(id);
  // åæ˜ 
  revealList.querySelectorAll('.revealRow').forEach(r=>{
    r.classList.toggle('selected', revealSelection.has(r.dataset.id));
  });
}

function moveReveal(id,delta){
  const idx=revealPool.indexOf(id);
  if(idx===-1) return;
  const to=Math.max(0, Math.min(revealPool.length-1, idx+delta));
  if(to===idx) return;
  revealPool.splice(idx,1);
  revealPool.splice(to,0,id);
  buildRevealList();
}

function toggleRevealSelectAll(){
  const doSel = revealSelection.size !== revealPool.length;
  revealSelection.clear();
  if(doSel) revealPool.forEach(id=>revealSelection.add(id));
  buildRevealList();
}

function revealMoveSelectedToHand(){
  if(!revealSelection.size){ alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const ids = revealPool.filter(id=>revealSelection.has(id));
  ids.forEach(id=>{
    // å…¬é–‹ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–
    const i=revealPool.indexOf(id); if(i!==-1) revealPool.splice(i,1);
    const c=state.cards[id];
    c.zone='hand';
    c.faceDown=false;
    placeInHand(c);
    bringToFront(id);
    renderCard(c);
  });
  revealSelection.clear();
  updateCounters();
  pushUndo();
  buildRevealList();
}

function revealMoveSelectedToDiscard(){
  if(!revealSelection.size){ alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const ids = revealPool.filter(id=>revealSelection.has(id));
  ids.forEach(id=>{
    const i=revealPool.indexOf(id); if(i!==-1) revealPool.splice(i,1);
    const c=state.cards[id];
    c.zone='discard';
    c.faceDown=true;
    hideIfPooled(c);
    if(!discardPool.includes(id)) discardPool.push(id);
    renderCard(c);
  });
  revealSelection.clear();
  updateCounters();
  pushUndo();
  buildRevealList();
}

function cleanupRevealTxn(){
  revealPool=[];
  revealOriginal=[];
  revealSelection.clear();
  revealTxnSnap=null;
  revealUndoMark=null;
}

function returnRevealToDeck(){
  if(!revealPool.length){ cleanupRevealTxn(); closeRevealModal(); return; }

  const order = revealPool.slice(); // ç¾åœ¨ã®ä¸¦ã³ï¼ˆorder[0]ãŒä¸€ç•ªä¸Šï¼‰
  deckPool = order.concat(deckPool);

  order.forEach(id=>{
    const c=state.cards[id];
    c.zone='deckMain';
    c.faceDown=true;
    hideIfPooled(c);
    renderCard(c);
  });

  cleanupRevealTxn();
  updateCounters();
  pushUndo();
  closeRevealModal();
}

function cancelReveal(){
  // å…¬é–‹ä¸­ã«ç©ã¾ã‚ŒãŸUndoã¯ç ´æ£„ï¼ˆå…¬é–‹é–‹å§‹å‰ã¾ã§æˆ»ã™ï¼‰
  if(typeof revealUndoMark==='number' && state.undoStack){
    if(state.undoStack.length>revealUndoMark) state.undoStack.length=revealUndoMark;
  }

  if(revealTxnSnap){
    // é–‹å§‹å‰ã‚¹ãƒŠãƒƒãƒ—ã¸ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆpushã—ãªã„ï¼‰
    loadFromJSON(revealTxnSnap,false);
  }else{
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå…¬é–‹ã‚«ãƒ¼ãƒ‰ã‚’å…ƒã®é †ã§æˆ»ã™
    if(revealPool.length){
      const order = (revealOriginal && revealOriginal.length) ? revealOriginal.slice() : revealPool.slice();
      deckPool = order.concat(deckPool);
      order.forEach(id=>{
        const c=state.cards[id];
        c.zone='deckMain';
        c.faceDown=true;
        hideIfPooled(c);
        renderCard(c);
      });
    }
    updateCounters();
  }

  cleanupRevealTxn();
  closeRevealModal();
}

// reveal modal handlers
if(btnRevealSelectAll) btnRevealSelectAll.onclick=toggleRevealSelectAll;
if(btnRevealToHand) btnRevealToHand.onclick=revealMoveSelectedToHand;
if(btnRevealToDiscard) btnRevealToDiscard.onclick=revealMoveSelectedToDiscard;
if(btnRevealReturn) btnRevealReturn.onclick=returnRevealToDeck;
if(btnRevealCancel) btnRevealCancel.onclick=cancelReveal;

if(revealModal){
  revealModal.addEventListener('click',e=>{ if(e.target===revealModal) cancelReveal(); });
  revealModal.addEventListener('keydown',e=>{
    if(e.key==='Escape'){ e.preventDefault(); cancelReveal(); }
  });
}




// viewer
const viewer=document.getElementById('viewer');
const viewerGrid=document.getElementById('viewerGrid');
const viewerSearchInput=document.getElementById('viewerSearch');
const viewerTitle=document.getElementById('viewerTitle');
const btnViewerToHand=document.getElementById('btnViewerToHand');
const btnViewerToDiscard=document.getElementById('btnViewerToDiscard');
const btnViewerCancel=document.getElementById('btnViewerCancel');
const btnViewerSelectAll=document.getElementById('btnViewerSelectAll');
let viewerMode='deck';let viewerSelection=new Set();

// preview
const preview=document.getElementById('preview');
const previewImg=document.getElementById('previewImg');
const previewClose=document.getElementById('previewClose');
// token selector refs
const tokenModal=document.getElementById('token');
const tokenGrid=document.getElementById('tokenGrid');
const tokenCountInput=document.getElementById('tokenCount');
const btnTokenCancel=document.getElementById('btnTokenCancel');
const btnTokenCreate=document.getElementById('btnTokenCreate');



// ===== ZONES =====
let zones = [];
const zoneDom = {};

/**
 * Mobile layout:
 * - Portrait, vertical scroll
 * - Two-column grid for setup zones (strategy/rage/deck/discard/monster)
 * - Two-column x4 rows for slots (1-8)
 * - Full-width hand at bottom
 *
 * NOTE: zones use PX coordinates (not ratios).
 */
function computeMobileZones(){
  const bw = board.clientWidth;

  const gap = 10;
  const safeTop = Math.max(8, (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-top'))||0));
  // Card size: tuned for phones. You can tweak these bounds if you want bigger/smaller.
  const cardW = Math.round(Math.min(175, Math.max(130, bw * 0.42)));
  document.documentElement.style.setProperty('--card-w', cardW + 'px');
  const cardH = cardW * 1.333;

  const colW = Math.floor((bw - gap*3) / 2);
  const rowH = Math.max(120, Math.round(cardH * 0.78));

  let y = safeTop + gap;

  zones = [];

  // --- Setup (3 rows / 2 columns) ---
  zones.push({ id:'strategy1', name:'æˆ¦ç•¥ã‚«ãƒ¼ãƒ‰ç½®ãå ´â‘ ', x:gap, y:y, w:colW, h:rowH });
  zones.push({ id:'rage',      name:'æ€’ã‚Šã‚«ãƒ¼ãƒ‰ç½®ãå ´',   x:gap*2+colW, y:y, w:colW, h:rowH });
  y += rowH + gap;

  zones.push({ id:'strategy2', name:'æˆ¦ç•¥ã‚«ãƒ¼ãƒ‰ç½®ãå ´â‘¡', x:gap, y:y, w:colW, h:rowH });
  zones.push({ id:'deckMain',  name:'å±±æœ­',              x:gap*2+colW, y:y, w:colW, h:rowH });
  y += rowH + gap;

  zones.push({ id:'monster',   name:'æ€ªç£ãƒ‡ãƒƒã‚­ç½®ãå ´',   x:gap, y:y, w:colW, h:rowH });
  zones.push({ id:'discard',   name:'æ¨ã¦æœ­',            x:gap*2+colW, y:y, w:colW, h:rowH });
  y += rowH + gap*2;

  // --- Field (slots) ---
  const slotH = Math.max(160, Math.round(cardH * 1.05));

  // Arrange so repel mapping feels "above":
  // 6 above 5, 7 above 4, 8 above 3 (roughly).
  const slots = [
    { id:'slot6', name:'6', col:0, row:0 },
    { id:'slot7', name:'7', col:1, row:0 },
    { id:'slot5', name:'5', col:0, row:1 },
    { id:'slot8', name:'8', col:1, row:1 },
    { id:'slot4', name:'4', col:0, row:2 },
    { id:'slot3', name:'3', col:1, row:2 },
    { id:'slot2', name:'2', col:0, row:3 },
    { id:'slot1', name:'1', col:1, row:3 }
  ];

  const fieldY = y;
  slots.forEach(s=>{
    zones.push({
      id: s.id,
      name: s.name,
      x: gap + s.col * (colW + gap),
      y: fieldY + s.row * (slotH + gap),
      w: colW,
      h: slotH
    });
  });

  y = fieldY + 4*(slotH + gap) + gap;

  // --- Hand ---
  const handH = Math.max(180, Math.round(cardH * 1.15));
  zones.push({ id:'hand', name:'æ‰‹æœ­', x:gap, y:y, w:(bw - gap*2), h:handH });

  // Board height = bottom of hand + safe space for the mobile bar
  const safeBottom = (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-bottom'))||0);
  const extra = 90 + safeBottom; // mobileBar space
  board.style.height = Math.ceil(y + handH + extra) + 'px';
}


function createZones(){
  // Clear old
  Object.values(zoneDom).forEach(d=>d.remove());
  for(const k in zoneDom) delete zoneDom[k];

  // Compute zones + board height
  computeMobileZones();

  zones.forEach(z=>{
    const d=document.createElement('div');
    d.className='zone';
    d.dataset.zoneId=z.id;
    if(/^slot\d+$/.test(z.id)) d.classList.add('slot-zone');

    d.style.left = z.x + 'px';
    d.style.top = z.y + 'px';
    d.style.width = z.w + 'px';
    d.style.height = z.h + 'px';

    const label=document.createElement('div');
    label.className='zone-label';
    label.textContent=z.name;
    d.appendChild(label);

    board.appendChild(d);
    zoneDom[z.id]=d;
  });

  const dz=zones.find(z=>z.id==='deckMain');
  if(dz){ deckCounterEl.style.left=(dz.x+4)+'px'; deckCounterEl.style.top=(dz.y+4)+'px'; }
  const cz=zones.find(z=>z.id==='discard');
  if(cz){ discardCounterEl.style.left=(cz.x+4)+'px'; discardCounterEl.style.top=(cz.y+4)+'px'; }
  const mz=zones.find(z=>z.id==='monster');
  if(mz){ monsterCounterEl.style.left=(mz.x+4)+'px'; monsterCounterEl.style.top=(mz.y+4)+'px'; }

  buildZoneControls();
  buildAreaControls();
}

function buildZoneControls(){
  document.querySelectorAll('.zoneUI,.rageUI').forEach(e=>e.remove());
  const mk=t=>{const b=document.createElement('button');b.textContent=t;return b;};
  const deckZ=zoneDom['deckMain'];if(deckZ){const ui=document.createElement('div');ui.className='zoneUI';const s=mk('ã‚µãƒ¼ãƒ'),rv=mk('å…¬é–‹'),sh=mk('ã‚·ãƒ£ãƒƒãƒ•ãƒ«'),d1=mk('1ãƒ‰ãƒ­ãƒ¼'),d5=mk('5ãƒ‰ãƒ­ãƒ¼');ui.append(s,rv,sh,d1,d5);deckZ.appendChild(ui);s.onclick=()=>openViewer('deck');rv.onclick=()=>openRevealPrompt();sh.onclick=()=>{shuffleDeck();pushUndo();};d1.onclick=()=>{drawFromDeck(1);pushUndo();};d5.onclick=()=>{drawFromDeck(5);pushUndo();};}
  const disZ=zoneDom['discard'];if(disZ){const ui=document.createElement('div');ui.className='zoneUI';const s=mk('ã‚µãƒ¼ãƒ'),bk=mk('å±±æœ­ã¸æˆ»ã™');ui.append(s,bk);disZ.appendChild(ui);s.onclick=()=>openViewer('discard');bk.onclick=()=>{if(discardToDeck()) pushUndo();};}
  const rageZ=zoneDom['rage'];if(rageZ){const ui=document.createElement('div');ui.className='rageUI';const span=document.createElement('span');span.id='rageCounter';span.textContent=rageCount;const wrap=document.createElement('div');wrap.className='rageBtns';const p=mk('æ€’ã‚Š+'),m=mk('æ€’ã‚Š-'),r=mk('ãƒªã‚»ãƒƒãƒˆ');wrap.append(p,m,r);ui.append(span,wrap);rageZ.appendChild(ui);p.onclick=()=>{rageCount++;updateRageDisplay();pushUndo();};m.onclick=()=>{rageCount=Math.max(0,rageCount-1);updateRageDisplay();pushUndo();};r.onclick=()=>{rageCount=0;updateRageDisplay();pushUndo();};}
}

function buildAreaControls(){
  document.querySelectorAll('.areaUI').forEach(e=>e.remove());
  const chain=['slot1','slot2','slot3','slot4','slot5','slot6','slot7','slot8'];const repel={slot6:'slot5',slot7:'slot4',slot8:'slot3'};
  chain.forEach(id=>{const dom=zoneDom[id];if(!dom)return;const ui=document.createElement('div');ui.className='areaUI';const f=document.createElement('button');f.textContent='å‰é€²';const b=document.createElement('button');b.textContent='å¾Œé€€';const s=document.createElement('button');s.textContent='é‡ãªã‚Š';ui.append(f,b,s);s.onclick=()=>openStack(id);if(repel[id]){const r=document.createElement('button');r.textContent='æ’ƒé€€';ui.append(r);r.onclick=()=>{moveZoneCards(id,repel[id]);pushUndo();};}dom.appendChild(ui);f.onclick=()=>{const i=chain.indexOf(id);if(i!==-1&&i<chain.length-1){moveZoneCards(id,chain[i+1]);pushUndo();}};b.onclick=()=>{const i=chain.indexOf(id);if(i>0){moveZoneCards(id,chain[i-1]);pushUndo();}};});
}

function moveZoneCards(fromId,toId){
  const zTo = zones.find(z=>z.id===toId);
  if(!zTo) return;

  // çµ±ä¸€é…ç½®ï¼šã‚¹ãƒŠãƒƒãƒ—ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§ã€ç§»å‹•å…ˆã‚¾ãƒ¼ãƒ³å†…ã®ä½ç½®ã‚’æƒãˆã‚‹ï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ’é™¤ï¼‰
  const ids = state.order.filter(id => state.cards[id] && state.cards[id].zone===fromId);
  ids.forEach(id=>{
    const c = state.cards[id];
    c.zone = toId;
    snapCardToZone(c, zTo);
    hideIfPooled(c);
    renderCard(c);
  });
}

function updateRageDisplay(){const el=document.getElementById('rageCounter');if(el)el.textContent=rageCount;}

// ===== STATE =====
let state={cards:{},order:[],undoStack:[]};
let deckPool=[],discardPool=[],monsterPool=[];let idCounter=0;let selection=new Set();const dupCountByName={};

createZones();
window.addEventListener('resize',()=>{
  Object.values(zoneDom).forEach(d=>d.remove());
  createZones();
  updateCounters();
  updateRageDisplay();
  layoutHand(); // â† è¿½åŠ 
});

// ===== file handlers =====
fileInput.addEventListener('change',e=>handleFiles(e.target.files));
backInput.addEventListener('change',e=>setBackImage(e.target.files));
window.addEventListener('drop',e=>{e.preventDefault();handleFiles(e.dataTransfer.files);});window.addEventListener('dragover',e=>e.preventDefault());

function handleFiles(fileList){[...fileList].forEach(f=>{if(!f.type.startsWith('image/'))return;const url=URL.createObjectURL(f);const name=f.name||url;addToDeck(url,name);});fileInput.value="";pushUndo();}
function setBackImage(files){if(!files||!files.length){backSrc=WHITE_BACK;updateBackImages();return;}const f=files[0];if(!f.type.startsWith('image/'))return;backSrc=URL.createObjectURL(f);backInput.value="";updateBackImages();pushUndo();}
function updateBackImages(){Object.values(state.cards).forEach(c=>{if(c.faceDown&&!['deckMain','discard'].includes(c.zone)){renderCard(c);}});}

function addToDeck(frontSrc,nameKey){dupCountByName[nameKey]=dupCountByName[nameKey]||0;if(dupCountByName[nameKey]>=MAX_DUP_PER_NAME){alert(`${nameKey} ã¯ä¸Šé™${MAX_DUP_PER_NAME}æšã§ã™`);return;}dupCountByName[nameKey]++;const card=spawnCard(frontSrc,{zone:'deckMain',faceDown:true,origName:nameKey});hideIfPooled(card);deckPool.push(card.id);updateCounters();}

function spawnCard(frontSrc,preset){
  const id='c'+(idCounter++);
  const bw=board.clientWidth,bh=board.clientHeight;
  const card={id,front:frontSrc,x:bw/2-60+Math.random()*120-60,y:bh/2-80+Math.random()*120-80,scale:1,rot:0,zone:null,faceDown:false,origName:''};

  if(preset) Object.assign(card,preset);

  // If spawned into a zone, place near that zone
  if(card.zone){
    const z=zones.find(z=>z.id===card.zone);
    if(z){
      card.x = z.x + 6 + Math.random()*20;
      card.y = z.y + 6 + Math.random()*20;
    }
  }

  state.cards[id]=card;
  state.order.push(id);
  renderCard(card);
  return card;
}

function currentSrc(card){if(IS_SPECTATOR && card.zone==='hand') return backSrc;return card.faceDown?backSrc:card.front;}
function renderCard(card){let el=document.getElementById(card.id);if(!el){el=document.createElement('img');el.id=card.id;el.className='card';el.addEventListener('pointerdown',ev=>startDrag(ev,card));el.addEventListener('wheel',ev=>onWheel(ev,card));el.addEventListener('click',ev=>onClickCard(ev,card));el.onerror=()=>{el.src=WHITE_BACK;};board.appendChild(el);}el.src=currentSrc(card);el.style.left=card.x+'px';el.style.top=card.y+'px';el.style.transform=`scale(${card.scale}) rotate(${card.rot}deg)`;hideIfPooled(card);}
function hideIfPooled(card){const el=document.getElementById(card.id);if(!el)return;if(['deckMain','discard'].includes(card.zone))el.classList.add('hidden');else el.classList.remove('hidden');}
function rerenderAll(){state.order.forEach(id=>renderCard(state.cards[id]));}

// selection / drag
function onClickCard(ev,card){if(ev.shiftKey){selection.has(card.id)?selection.delete(card.id):selection.add(card.id);}else{selection.clear();selection.add(card.id);}updateSelectionVisual();ev.stopPropagation();}
board.addEventListener('click',()=>{selection.clear();updateSelectionVisual();});
function updateSelectionVisual(){document.querySelectorAll('.card').forEach(e=>e.classList.remove('selected'));selection.forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('selected');});}
let dragInfo=null;function startDrag(ev,card){ev.preventDefault();ev.stopPropagation();// æ—¢ã«è¤‡æ•°é¸æŠã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã€ãã®ä¸­ã®1æšã‚’ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãŸæ™‚ã¯é¸æŠã‚’å´©ã•ãªã„
const keepGroup=(!ev.shiftKey && selection.size>1 && selection.has(card.id));const multi=ev.shiftKey;if(!multi && !keepGroup){selection.clear();selection.add(card.id);updateSelectionVisual();}else if(multi && !selection.has(card.id)){selection.add(card.id);updateSelectionVisual();}let ids=[...selection];
  // Alt+ãƒ‰ãƒ©ãƒƒã‚°ï¼šåŒä¸€ã‚¾ãƒ¼ãƒ³ï¼ˆã‚¨ãƒªã‚¢ï¼‰ã®ã‚«ãƒ¼ãƒ‰ã‚’ã¾ã¨ã‚ã¦ç§»å‹•
  if(ev.altKey && card.zone && card.zone!=='hand' && card.zone!=='deckMain' && card.zone!=='discard'){
    const zIds=getZoneCardIds(card.zone);
    if(zIds.length>1){
      ids = zIds.slice(); // å¥¥â†’æ‰‹å‰ï¼ˆstate.orderæº–æ‹ ï¼‰
      // é¸æŠè¡¨ç¤ºã‚‚æŸã«æƒãˆã‚‹
      selection.clear(); zIds.forEach(id=>selection.add(id));
      updateSelectionVisual();
    }
  }const rects=ids.map(id=>{const c=state.cards[id];return{id,dx:ev.clientX-c.x,dy:ev.clientY-c.y};});dragInfo={ids,rects};rects.forEach(r=>{const el=document.getElementById(r.id);el.classList.add('active');el.setPointerCapture(ev.pointerId);});board.addEventListener('pointermove',onDragMove);board.addEventListener('pointerup',onDragEnd,{once:true});board.addEventListener('pointercancel',onDragEnd,{once:true});}
function onDragMove(ev){if(!dragInfo)return;dragInfo.rects.forEach(r=>{const c=state.cards[r.id];c.x=ev.clientX-r.dx;c.y=ev.clientY-r.dy;renderCard(c);});scheduleSpectatorSyncFast();}
function onDragEnd(ev){
  if(!dragInfo) return;
  dragInfo.rects.forEach(r=>{
    const el=document.getElementById(r.id);
    el.classList.remove('active');
    el.releasePointerCapture(ev.pointerId);

    const c=state.cards[r.id];
    const z=hitZone(c);
    c.zone = z ? z.id : null;

    updatePoolsMembership(c);
    hideIfPooled(c);

    if (snapEnabled && z) snapCardToZone(c, z);
    renderCard(c); // â†ã‚¹ãƒŠãƒƒãƒ—å¾Œã®åº§æ¨™ã‚’åæ˜ 
  });
  // ãƒ­ã‚°ï¼ˆç§»å‹•ï¼‰
  try{
    const n = dragInfo.rects?.length || 0;
    if(n>0){
      const zonesAfter = [...new Set(dragInfo.rects.map(r=>state.cards[r.id]?.zone||null))];
      if(zonesAfter.length===1){
        const zId = zonesAfter[0];
        const z = (typeof zones!=='undefined' && Array.isArray(zones)) ? zones.find(z=>z.id===zId) : null;
        const nm = (z ? z.name : (zId||'å ´'));
        window.logAction && window.logAction(`ç§»å‹•ï¼š${n}æš â†’ ${nm}`);
      }else{
        window.logAction && window.logAction(`ç§»å‹•ï¼š${n}æš`);
      }
    }
  }catch(e){}
  dragInfo=null;
  pushUndo();
  updateCounters();
}
function hitZone(card){
  const cw=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w'));
  const centerX=card.x+(cw*card.scale)/2;
  const centerY=card.y+(cw*1.333*card.scale)/2;

  for(const z of zones){
    const zx=z.x, zy=z.y, zw=z.w, zh=z.h;
    if(centerX>zx && centerX<zx+zw && centerY>zy && centerY<zy+zh){
      return z;
    }
  }
  return null;
}

let snapEnabled = true;              // ã‚¹ãƒŠãƒƒãƒ—ON/OFF
const SNAP_STACK_DX = 10;            // åŒã˜æ ã«é‡ãªã£ãŸæ™‚ã®ã‚ºãƒ©ã—
const SNAP_STACK_DY = 6;

function cardSize(card){
  const cw = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w'));
  const w = cw * card.scale;
  const h = cw * 1.333 * card.scale; // hitZone()ã¨åŒã˜æ¯”ç‡
  return { w, h };
}

function snapCardToZone(card, z){
  // æ‰‹æœ­ã¯æ—¢å­˜ã®æ•´åˆ—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ã†
  if (z.id === 'hand') { placeInHand(card); return; }

  // å±±æœ­/æ¨ã¦æœ­/æ€ªç£ã¯éè¡¨ç¤ºã«ãªã‚‹ã®ã§ä½ç½®ã¯é‡è¦ã˜ã‚ƒãªã„
  if (['deckMain','discard','monster'].includes(z.id)) return;

  const { w, h } = cardSize(card);

  // ã‚¾ãƒ¼ãƒ³ä¸­å¤®ã«å¯„ã›ã‚‹
  let x = z.x + (z.w - w)/2;
  let y = z.y + (z.h - h)/2;

  // åŒã˜ã‚¾ãƒ¼ãƒ³ã«æ—¢ã«ã‚ã‚‹æšæ•°ã¶ã‚“ã€ã¡ã‚‡ã£ã¨ã ã‘ãšã‚‰ã—ã¦é‡ãªã‚ŠãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  const siblings = Object.values(state.cards).filter(c => c.id !== card.id && c.zone === z.id);
  x += siblings.length * SNAP_STACK_DX;
  y += siblings.length * SNAP_STACK_DY;

  card.x = x;
  card.y = y;
}

// [patch] ç›¤é¢â†’å±±æœ­ã¸æˆ»ã™éš›ã®æŒ¿å…¥ä½ç½®ã‚’é¸æŠ(ä¸Š/ä¸‹)
function updatePoolsMembership(card){
  if(card.zone==='deckMain'){
    if(!deckPool.includes(card.id)){
      if(deckReturnPos==='top'){deckPool.unshift(card.id);}else{deckPool.push(card.id);}
    }
    card.faceDown=true;
    hideIfPooled(card);
  }else{
    const i=deckPool.indexOf(card.id);if(i!==-1)deckPool.splice(i,1);
  }
  if(card.zone==='discard'){
    if(!discardPool.includes(card.id))discardPool.push(card.id);
    card.faceDown=true;hideIfPooled(card);
  }else{
    const j=discardPool.indexOf(card.id);if(j!==-1)discardPool.splice(j,1);
  }
  if(card.zone==='monster'){
    if(!monsterPool.includes(card.id))monsterPool.push(card.id);
    card.faceDown=true;
  }else{
    const k=monsterPool.indexOf(card.id);if(k!==-1)monsterPool.splice(k,1);
  }
}

function onWheel(ev,card){
  if(!ev.altKey) return;
  ev.preventDefault();
  const d = Math.sign(ev.deltaY) * -0.05;
  card.scale = Math.max(0.3, Math.min(2.5, card.scale + d));

  if(card.zone === 'hand') layoutHand();
  else renderCard(card);

  pushUndoDebounced();
}



// [patch] è¡¨è£åè»¢ãƒœã‚¿ãƒ³ï¼šé¸æŠã‚«ãƒ¼ãƒ‰ã‚’è¡¨/è£åè»¢ï¼ˆFã‚­ãƒ¼ï¼‰
btnFlip.onclick=()=>{
  if(!selection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  let needLayout=false;
  selection.forEach(id=>{
    const c=state.cards[id]; if(!c) return;
    // å±±æœ­/æ¨ã¦æœ­ã¯éè¡¨ç¤ºãªã®ã§å¯¾è±¡å¤–ï¼ˆå…¬é–‹ã¯å°‚ç”¨UIã§ï¼‰
    if(c.zone==='deckMain' || c.zone==='discard') return;
    c.faceDown=!c.faceDown;
    if(c.zone==='hand') needLayout=true;
    else renderCard(c);
  });
  if(needLayout) layoutHand();
  pushUndo();
};


// [patch] æ¶ˆæ»…ãƒœã‚¿ãƒ³ï¼šé¸æŠã‚«ãƒ¼ãƒ‰ã‚’å®Œå…¨å‰Šé™¤
btnRemove.onclick=()=>{if(!selection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}selection.forEach(id=>removeCardById(id));selection.clear();updateSelectionVisual();updateCounters();pushUndo();};
function removeCardById(id){
  const i=deckPool.indexOf(id);if(i!==-1)deckPool.splice(i,1);
  const j=discardPool.indexOf(id);if(j!==-1)discardPool.splice(j,1);
  const k=monsterPool.indexOf(id);if(k!==-1)monsterPool.splice(k,1);
  const el=document.getElementById(id);if(el)el.remove();
  delete state.cards[id];
  state.order=state.order.filter(x=>x!==id);
}

btnToFront.onclick=()=>{if(!selection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}selection.forEach(id=>bringToFront(id));pushUndo();};
btnToBack.onclick=()=>{if(!selection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}selection.forEach(id=>bringToBack(id));pushUndo();};
btnUndo.onclick=undo;btnSave.onclick=saveLocal;btnLoad.onclick=loadLocal;
if(btnOpenSpectator) btnOpenSpectator.onclick=openSpectatorWindow;btnTurnStart.onclick=()=>{turnStart();};btnPreview.onclick=openPreview;btnBackToMode.onclick=()=>{goBackToMode();};
btnToken.onclick=()=>{openTokenSelector();};
if(btnCoin) btnCoin.onclick=doCoinToss;
if(btnPhase) btnPhase.onclick=nextPhase;
updatePhaseUI();
updateCoinUI();

// [patch] keyboard shortcuts
// F = è¡¨è£åè»¢ / Delete = æ¶ˆæ»…
document.addEventListener('keydown',(e)=>{if(IS_SPECTATOR) return;
  if(e.defaultPrevented) return;
  if(e.repeat) return;

  const ae=document.activeElement;
  if(ae && (ae.tagName==='INPUT' || ae.tagName==='TEXTAREA' || ae.isContentEditable)) return;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«/ãƒ“ãƒ«ãƒ€ãƒ¼ä¸­ã¯èª¤çˆ†é˜²æ­¢
  try{
    if(startModal && startModal.style.display!=='none') return;
    if(viewer && !viewer.classList.contains('hidden')) return;
    if(reveal && !reveal.classList.contains('hidden')) return;
    if(tokenModal && !tokenModal.classList.contains('hidden')) return;
    if(stackModal && !stackModal.classList.contains('hidden')) return;
    if(preview && !preview.classList.contains('hidden')) return;
    if(builder && !builder.classList.contains('hidden')) return;
  }catch(err){}

  if(e.key==='f' || e.key==='F'){
    e.preventDefault();
    btnFlip.click();
  }else if(e.key==='Delete'){
    e.preventDefault();
    btnRemove.click();
  }else if(e.code==='Space' || e.key===' '){
    e.preventDefault();
    openPreview();
  }
});

function bringToFront(id){state.order=state.order.filter(x=>x!==id);state.order.push(id);const el=document.getElementById(id);if(el)board.appendChild(el);} 
function bringToBack(id){state.order=state.order.filter(x=>x!==id);state.order.unshift(id);const el=document.getElementById(id);if(el){const first=board.querySelector('.card');if(first)board.insertBefore(el,first);else board.appendChild(el);}}

// preview
function openPreview(){if(!selection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}const id=[...selection][selection.size-1];const c=state.cards[id];previewImg.src=c.front;preview.classList.remove('hidden');}
function closePreview(){preview.classList.add('hidden');}
previewClose.onclick=closePreview;preview.addEventListener('click',e=>{if(e.target===preview)closePreview();});
// [fix] preview openä¸­ã¯ Esc ã§é–‰ã˜ã‚‹
document.addEventListener('keydown',(e)=>{if(IS_SPECTATOR) return; if(!preview.classList.contains('hidden') && e.key==='Escape'){e.preventDefault(); closePreview();}});


// token selector
let tokenSelection=null;
function openTokenSelector(){
  tokenSelection=null;tokenGrid.innerHTML='';tokenCountInput.value='1';
  const tokens=['BP02-T01','BP02-T02','BP02-T03','BP02-T04'];
  tokens.forEach(id=>{
    const w=document.createElement('div');w.className='tokenThumb';w.dataset.id=id;
    const img=document.createElement('img');img.src=`${CARD_FOLDER}/${id}.png`;img.onerror=()=>{img.src=WHITE_BACK;};
    const nm=document.createElement('div');nm.className='tokenName';nm.textContent=id.replace('BP02-','');
    w.appendChild(img);w.appendChild(nm);
    w.onclick=()=>{
      tokenSelection=id;
      tokenGrid.querySelectorAll('.tokenThumb').forEach(el=>el.classList.toggle('selected',el.dataset.id===id));
    };
    tokenGrid.appendChild(w);
  });
  // åˆæœŸé¸æŠï¼ˆæœ€åˆã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
  const first=tokenGrid.querySelector('.tokenThumb');
  if(first){tokenSelection=first.dataset.id;first.classList.add('selected');}
  tokenModal.classList.remove('hidden');
}
function closeTokenSelector(){tokenModal.classList.add('hidden');}
btnTokenCancel.onclick=closeTokenSelector;
btnTokenCreate.onclick=()=>{
  if(!tokenSelection){alert('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const n=Math.max(1,Math.min(20,parseInt(tokenCountInput.value||'1',10)||1));
  const src=`${CARD_FOLDER}/${tokenSelection}.png`;
  spawnTokens(src,tokenSelection,n);
  pushUndo();
  closeTokenSelector();
};
// Enterã§ç”Ÿæˆã€Escã§é–‰ã˜ã‚‹
tokenModal.addEventListener('keydown',e=>{
  if(e.key==='Enter'){e.preventDefault();btnTokenCreate.click();}
  if(e.key==='Escape'){e.preventDefault();closeTokenSelector();}
});
function spawnTokens(src,origName,count){
  const z=zones.find(z=>z.id==='hand');
  const bw=board.clientWidth,bh=board.clientHeight;
  const baseX=z.x-120; // ã•ã‚‰ã«å·¦ã¸ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  const baseY=z.y+10;
  for(let i=0;i<count;i++){
    const c=spawnCard(src,{zone:null,faceDown:false,origName});
    c.x=baseX- (i*2);
    c.y=baseY+ (i*2);
    renderCard(c);bringToFront(c.id);
  }
}

// viewer
function openViewer(mode){if(IS_SPECTATOR) return;if(revealIsOpen()){alert('å…¬é–‹ä¸­ã§ã™ã€‚å…ˆã«å…¬é–‹ã‚«ãƒ¼ãƒ‰ã‚’å‡¦ç†ã—ã¦ãã ã•ã„ã€‚');return;}viewerMode=mode;viewerSelection.clear();lastViewerPickedId=null;viewerTitle.textContent=mode==='deck'?'å±±æœ­ã‚’ã‚µãƒ¼ãƒ':'æ¨ã¦æœ­ã‚’ã‚µãƒ¼ãƒ';viewerSearchInput.value='';buildViewerGrid();btnViewerToDiscard.style.display=(mode==='deck')?'':'none';viewer.classList.remove('hidden');viewerSearchInput.focus();sendViewerUiToSpectator();sendPickToSpectator();}
function closeViewer(){viewer.classList.add('hidden');viewerSelection.clear();lastViewerPickedId=null;sendViewerUiToSpectator();sendPickToSpectator();}
function buildViewerGrid(){viewerGrid.innerHTML='';const list=(viewerMode==='deck'?deckPool:discardPool).map(id=>state.cards[id]);list.forEach(c=>{const w=document.createElement('div');w.className='thumbWrap';w.dataset.id=c.id;const img=document.createElement('img');img.src=c.front;w.appendChild(img);const nm=document.createElement('div');nm.className='thumbName';nm.textContent=c.origName||'';w.appendChild(nm);w.onclick=()=>toggleThumb(w);viewerGrid.appendChild(w);});}
function toggleThumb(w){if(IS_SPECTATOR) return;const id=w.dataset.id;lastViewerPickedId=id;if(viewerSelection.has(id)){viewerSelection.delete(id);w.classList.remove('selected');}else{viewerSelection.add(id);w.classList.add('selected');}if(viewerMode==='deck'){sendPickToSpectator();}sendViewerUiToSpectator();}
function toggleViewerSelectAll(){if(IS_SPECTATOR) return;const all=[...viewerGrid.querySelectorAll('.thumbWrap')];const doSel=viewerSelection.size!==all.length;viewerSelection.clear();all.forEach(w=>{if(doSel){viewerSelection.add(w.dataset.id);w.classList.add('selected');}else{w.classList.remove('selected');}});if(viewerMode==='deck'){lastViewerPickedId=null;sendPickToSpectator();}sendViewerUiToSpectator();}
viewerSearchInput.addEventListener('input',()=>{const q=viewerSearchInput.value.toLowerCase();viewerGrid.querySelectorAll('.thumbWrap').forEach(w=>{const id=w.dataset.id;const c=state.cards[id];const hit=(c.origName||'').toLowerCase().includes(q);w.style.display=hit?'':'';});});
btnViewerCancel.onclick=closeViewer;btnViewerSelectAll.onclick=toggleViewerSelectAll;btnViewerToHand.onclick=viewerMoveToHand;btnViewerToDiscard.onclick=viewerMoveToDiscard;
function viewerMoveToHand(){if(!viewerSelection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}viewerSelection.forEach(id=>{const arr=viewerMode==='deck'?deckPool:discardPool;const idx=arr.indexOf(id);if(idx!==-1)arr.splice(idx,1);const c=state.cards[id];c.zone='hand';c.faceDown=false;placeInHand(c);bringToFront(id);renderCard(c);});updateCounters();pushUndo();closeViewer();}
function viewerMoveToDiscard(){if(viewerMode!=='deck')return;if(!viewerSelection.size){alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}viewerSelection.forEach(id=>{const idx=deckPool.indexOf(id);if(idx!==-1)deckPool.splice(idx,1);const c=state.cards[id];c.zone='discard';c.faceDown=true;hideIfPooled(c);if(!discardPool.includes(id))discardPool.push(id);renderCard(c);});updateCounters();pushUndo();closeViewer();}

// counters & pools
function updateCounters(){deckCounterEl.textContent=`å±±æœ­:${deckPool.length}æš`;discardCounterEl.textContent=`æ¨ã¦æœ­:${discardPool.length}æš`;monsterCounterEl.textContent=`æ€ªç£:${monsterPool.length}æš`;}
function shuffleDeck(){for(let i=deckPool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deckPool[i],deckPool[j]]=[deckPool[j],deckPool[i]];}deckPool.forEach(id=>{const c=state.cards[id];c.zone='deckMain';c.faceDown=true;hideIfPooled(c);});updateCounters();}

// [fix] æ¨ã¦æœ­â†’å±±æœ­ã¸æˆ»ã™ï¼ˆæ¨ã¦æœ­ã‚¾ãƒ¼ãƒ³ã®ã€Œå±±æœ­ã¸æˆ»ã™ã€ãƒœã‚¿ãƒ³ï¼‰
function discardToDeck(){
  if(IS_SPECTATOR) return false;
  const n = discardPool.length;
  if(n===0){ alert('æ¨ã¦æœ­ãŒã‚ã‚Šã¾ã›ã‚“'); return false; }
  if(!confirm(`æ¨ã¦æœ­${n}æšã‚’å±±æœ­ã¸æˆ»ã—ã¾ã™ã‹ï¼Ÿ`)) return false;

  const moving = discardPool.slice(); // å¤ã„â†’æ–°ã—ã„ï¼ˆæœ«å°¾ãŒä¸€ç•ªä¸Šï¼‰
  // å…ˆã«ã‚«ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’æ›´æ–°
  moving.forEach(id=>{
    const c = state.cards[id];
    if(!c) return;
    c.zone = 'deckMain';
    c.faceDown = true;
    hideIfPooled(c);
    renderCard(c);
  });

  // å±±æœ­ã¸è¿½åŠ ï¼ˆæˆ»ã™ä½ç½®ï¼šä¸Š/ä¸‹ï¼‰
  if(deckReturnPos==='top'){
    // æœ«å°¾ï¼ˆæ¨ã¦æœ­ã®ä¸€ç•ªä¸Šï¼‰ãŒæ–°ã—ã„å±±æœ­ã®ä¸€ç•ªä¸Šã«ãªã‚‹ã‚ˆã†ã« unshift ã‚’é †ã«å®Ÿè¡Œ
    moving.forEach(id=>{
      if(!deckPool.includes(id)) deckPool.unshift(id);
    });
  }else{
    moving.forEach(id=>{
      if(!deckPool.includes(id)) deckPool.push(id);
    });
  }

  // æ¨ã¦æœ­ã¯ç©ºã«
  discardPool = [];

  // ãƒ“ãƒ¥ãƒ¼ã‚¢è¡¨ç¤ºä¸­ãªã‚‰æ›´æ–°
  try{
    if(typeof viewerMode!=='undefined' && viewerMode==='discard' && viewer && !viewer.classList.contains('hidden')){
      viewerSelection?.clear?.();
      lastViewerPickedId = null;
      buildViewerGrid();
      sendViewerUiToSpectator();
      sendPickToSpectator();
    }
  }catch(e){}

  updateCounters();
  return true;
}


// [patch] ãƒ‰ãƒ­ãƒ¼ã¯ deckPool å…ˆé ­ã‹ã‚‰
function drawFromDeck(n){
  for(let i=0;i<n;i++){
    if(deckPool.length===0)break;
    const id=deckPool.shift();
    const c=state.cards[id];
    c.zone='hand';
    c.faceDown=false;
    placeInHand(c);
    bringToFront(id);
    renderCard(c);
  }
  updateCounters();
}

// ã©ã“ã‹ã‚‰å‘¼ã°ã‚Œã¦ã‚‚ã€Œæ‰‹æœ­ã¯å…¨éƒ¨æ•´åˆ—ã™ã‚‹ã€
let handOrderCounter = 0;

function layoutHand(){
  const z = zones.find(z=>z.id==='hand');
  if(!z) return;

  const startX = z.x + 20;
  const y      = z.y - 10;
  const endX   = z.x + z.w - 20;
  const avail  = Math.max(0, endX - startX);

  const baseW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w'));
  const handCards = Object.values(state.cards).filter(c => c.zone === 'hand');
  if(!handCards.length) return;

  // æ—¢å­˜ã®é †ç•ªãŒã‚ã‚Œã°ãã‚Œã‚’æ´»ã‹ã™ï¼ˆä¿å­˜/èª­è¾¼å¾Œã‚‚å´©ã‚Œã«ãã„ï¼‰
  handOrderCounter = Math.max(handOrderCounter, ...handCards.map(c=>c._handOrder||0));

  handCards.forEach(c=>{
    if(c._handOrder == null) c._handOrder = ++handOrderCounter;
  });
  handCards.sort((a,b)=>(a._handOrder||0)-(b._handOrder||0));

  const widths = handCards.map(c => baseW * c.scale);
  const totalW = widths.reduce((s,w)=>s+w,0);

  const BASE_GAP = 14;     // ä½™è£•ã‚ã‚‹æ™‚ã®éš™é–“
  const MIN_STEP = 28;     // â€œè©°ã‚ã™ãâ€é˜²æ­¢ï¼ˆæ¬¡ã®ã‚«ãƒ¼ãƒ‰ãŒæœ€ä½ã“ã‚Œã ã‘è¦‹ãˆã‚‹ï¼‰
  let gap = BASE_GAP;

  if(handCards.length > 1){
    const needGap = (avail - totalW) / (handCards.length - 1);
    const minW = Math.min(...widths);
    const minGap = MIN_STEP - minW;      // step = minW + gap >= MIN_STEP
    gap = Math.max(minGap, Math.min(BASE_GAP, needGap));
  }

  let x = startX;
  for(let i=0;i<handCards.length;i++){
    const c = handCards[i];
    c.x = x;
    c.y = y;
    x += widths[i] + gap;
    renderCard(c);
  }
}

function placeInHand(card){
  if(card._handOrder == null) card._handOrder = ++handOrderCounter;
  layoutHand();
}





// [patch] moveSelectionToZone çµŒç”±ã§ã‚‚æˆ»ã—ä½ç½®ã‚’åæ˜ 
function moveSelectionToZone(zoneId){
  const z=zones.find(z=>z.id===zoneId);
  if(!z) return;

  selection.forEach(id=>{
    const c=state.cards[id];
    c.zone=zoneId;

    if(zoneId==='deckMain'){
      c.faceDown=true;
      hideIfPooled(c);
      if(!deckPool.includes(id)){
        if(deckReturnPos==='top'){ deckPool.unshift(id); }
        else { deckPool.push(id); }
      }
      const j=discardPool.indexOf(id); if(j!==-1) discardPool.splice(j,1);
    }else if(zoneId==='discard'){
      c.faceDown=true;
      hideIfPooled(c);
      if(!discardPool.includes(id)) discardPool.push(id);
      const i=deckPool.indexOf(id); if(i!==-1) deckPool.splice(i,1);
    }else if(zoneId==='hand'){
      c.faceDown=false;
      placeInHand(c);
      hideIfPooled(c);
      const i=deckPool.indexOf(id); if(i!==-1) deckPool.splice(i,1);
      const j=discardPool.indexOf(id); if(j!==-1) discardPool.splice(j,1);
    }else{
      c.x = z.x + 6 + Math.random()*20;
      c.y = z.y + 6 + Math.random()*20;
      hideIfPooled(c);
      const i=deckPool.indexOf(id); if(i!==-1) deckPool.splice(i,1);
      const j=discardPool.indexOf(id); if(j!==-1) discardPool.splice(j,1);
    }

    renderCard(c);
  });

  updateCounters();
}

function turnStart(){['strategy1','strategy2'].forEach(zid=>{Object.values(state.cards).forEach(c=>{if(c.zone===zid){c.zone='discard';c.faceDown=true;hideIfPooled(c);if(!discardPool.includes(c.id))discardPool.push(c.id);const di=deckPool.indexOf(c.id);if(di!==-1)deckPool.splice(di,1);renderCard(c);}});});rageCount=0;updateRageDisplay();updateCounters();pushUndo();}

// undo/save
function pushUndo(){const snap=JSON.stringify(lightState());state.undoStack.push(snap);if(state.undoStack.length>50)state.undoStack.shift();}
let undoTimer=null;function pushUndoDebounced(){clearTimeout(undoTimer);undoTimer=setTimeout(pushUndo,400);} 
function undo(){
  // å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­ã®Undoã¯ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆé–‹å§‹å‰ã¸æˆ»ã™ï¼‰ã€ã¨ã—ã¦æ‰±ã†
  if(revealIsOpen() || revealPool.length){ cancelReveal(); return; }
  if(state.undoStack.length<2) return;
  state.undoStack.pop();
  loadFromJSON(state.undoStack[state.undoStack.length-1],false);
} 
function lightState(){const {cards,order}=state;return {cards,order,deckPool,discardPool,monsterPool,dupCountByName,backSrc,rageCount,phaseIndex,lastCoin};}
function saveLocal(){try{const json=JSON.stringify(lightState());const bytes=new Blob([json]).size;if(bytes>MAX_SAVE_BYTES){alert(`ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ (ç´„${(bytes/1024).toFixed(1)}KB)`);return;}localStorage.setItem('go_state',json);alert('ä¿å­˜ã—ã¾ã—ãŸ');}catch(e){alert('ä¿å­˜ä¸­ã‚¨ãƒ©ãƒ¼:'+e.message);}}
function loadLocal(){try{const json=localStorage.getItem('go_state');if(!json){alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return;}loadFromJSON(json,true);}catch(e){alert('èª­è¾¼ä¸­ã‚¨ãƒ©ãƒ¼:'+e.message);}}
function loadFromJSON(json,push=true){
  // æ—¢å­˜DOMã‚’å‰Šé™¤
  Object.values(state.cards).forEach(c=>{
    const el=document.getElementById(c.id);
    if(el) el.remove();
  });

  const p=JSON.parse(json);
  state.cards=p.cards||{};
  state.order=p.order||Object.keys(state.cards);
  deckPool=p.deckPool||[];
  discardPool=p.discardPool||[];
  monsterPool=p.monsterPool||[];
  Object.assign(dupCountByName,p.dupCountByName||{});
  backSrc=p.backSrc||WHITE_BACK;
  rageCount=p.rageCount||0;
  // phase/coin meta
  try{ phaseIndex = (typeof p.phaseIndex==='number') ? p.phaseIndex : 0; }catch(e){ phaseIndex = 0; }
  try{ lastCoin = (Object.prototype.hasOwnProperty.call(p,'lastCoin')) ? p.lastCoin : null; }catch(e){ lastCoin = null; }

  // è¦³æˆ¦(spectator)å´ã¯å…¬é–‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ GCARD_REVEAL ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€
  // GCARD_SYNC ã®ãŸã³ã«å‹æ‰‹ã«é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆã“ã“ãŒã€Œä¸€ç¬ã§é–‰ã˜ã‚‹ã€åŸå› ï¼‰
  if(!IS_SPECTATOR){
    revealPool=[];
    revealOriginal=[];
    revealSelection.clear();
    revealTxnSnap=null;
    revealUndoMark=null;
    closeRevealModal();
  }

  idCounter=Object.keys(state.cards).length;
  state.order.forEach(id=>renderCard(state.cards[id]));
  updateCounters();
  updateRageDisplay();
  updatePhaseUI();
  updateCoinUI();

  if(!IS_SPECTATOR){
    if(revealPool && revealPool.length){ showRevealModal(); }
    else { closeRevealModal(); }
  }

  if(push) pushUndo();
  selection.clear();
  updateSelectionVisual();
}

// ===== start modal handlers =====
btnStartBuild.onclick=()=>{startModal.style.display='none';openBuilder();};
btnStartPlay.onclick=()=>{startModal.style.display='none';toolbar.classList.remove('hidden');phaseIndex=0;lastCoin=null;updatePhaseUI();updateCoinUI();autoLoadBackImage();};
function goBackToMode(){if(revealIsOpen()) cancelReveal(); toolbar.classList.add('hidden');viewer.classList.add('hidden');preview.classList.add('hidden');builder.classList.add('hidden');startModal.style.display='flex';}

// ===== è‡ªå‹•è£é¢èª­ã¿è¾¼ã¿ =====
// undoã§ã€Œè£é¢ãŒç™½ã«æˆ»ã‚‹ã€ã‚’é˜²ããŸã‚ã€autoèª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã¯ undoå±¥æ­´å†…ã® backSrc ã‚’åŒæœŸã™ã‚‹
function patchUndoBackSrc(src){
  try{
    if(!state || !state.undoStack) return;
    state.undoStack = state.undoStack.map(s=>{
      try{ const o = JSON.parse(s); o.backSrc = src; return JSON.stringify(o); }
      catch(e){ return s; }
    });
  }catch(e){}
}
function autoLoadBackImage(){
  // ã™ã§ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè£é¢ã‚’æŒ‡å®šã—ã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„
  if(backSrc && backSrc !== WHITE_BACK) return;

  const path = `${CARD_FOLDER}/è£é¢.png`;
  const img = new Image();
  img.onload = ()=>{
    backSrc = path;
    updateBackImages();
    patchUndoBackSrc(backSrc); // ã“ã“ãŒé‡è¦ï¼šéå»ã‚¹ãƒŠãƒƒãƒ—ã® backSrc ã‚‚åˆã‚ã›ã‚‹
  };
  img.onerror = ()=>{
    // è‡ªå‹•èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯ç¾çŠ¶ç¶­æŒï¼ˆåˆæœŸçŠ¶æ…‹ãªã‚‰WHITE_BACKã®ã¾ã¾ï¼‰
    if(!backSrc) backSrc = WHITE_BACK;
  };
  img.src = path;
}

// ===== Deck Builder =====
let buildMain={},buildMon={};
// --- Deck Save/Load (æ§‹ç¯‰ãƒ¢ãƒ¼ãƒ‰) ---
const DECKS_KEY='go_decks_v1';
let activeDeckId=null;

function safeJSONParse(s,fallback){
  try{ const v=JSON.parse(s); return (v===null||v===undefined)?fallback:v; }catch(e){ return fallback; }
}
function getDeckSaves(){
  const raw=localStorage.getItem(DECKS_KEY);
  if(!raw) return [];
  const v=safeJSONParse(raw,[]);
  if(Array.isArray(v)) return v;
  if(v && Array.isArray(v.decks)) return v.decks;
  return [];
}
function setDeckSaves(decks){
  try{ localStorage.setItem(DECKS_KEY, JSON.stringify(decks)); }catch(e){ alert('ä¿å­˜å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™'); }
}
function newId(){
  try{ return crypto.randomUUID(); }catch(e){}
  return 'd_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8);
}
function cloneDeckObj(obj){
  const main = Object.assign({}, obj?.main||{});
  const monster = Object.assign({}, obj?.monster||{});
  return {main, monster};
}
function currentDeckObj(){ return {main:Object.assign({},buildMain), monster:Object.assign({},buildMon)}; }

function fmtJP(iso){
  try{
    const d=new Date(iso);
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    const hh=String(d.getHours()).padStart(2,'0');
    const mm=String(d.getMinutes()).padStart(2,'0');
    return `${y}/${m}/${da} ${hh}:${mm}`;
  }catch(e){ return ''; }
}

function applyDeckToBuilder(deck){
  buildMain = Object.assign({}, deck?.main||{});
  buildMon  = Object.assign({}, deck?.monster||{});
  renderDeckThumbs();
  updateBuildCount();
  try{ deckCodeBox.value = encodeDeck({main:buildMain, monster:buildMon}); }catch(e){}
}

function saveDeckPrompt(){
  const defaultName = (()=> {
    const decks=getDeckSaves();
    const cur = activeDeckId ? decks.find(d=>d.id===activeDeckId) : null;
    return cur?.name || '';
  })();
  const name = prompt('ãƒ‡ãƒƒã‚­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', defaultName);
  if(!name) return;

  const deck = currentDeckObj();
  const now = new Date().toISOString();
  const decks = getDeckSaves();

  // å®Œæˆã—ã¦ãªã„å ´åˆã¯ä¸€å¿œç¢ºèª
  const mCnt=sumObj(buildMain), kCnt=sumObj(buildMon);
  if((mCnt!==MAIN_LIMIT || kCnt!==MON_LIMIT) && !confirm(`æšæ•°ãŒæœªå®Œæˆã§ã™ï¼ˆãƒ¡ã‚¤ãƒ³ ${mCnt}/${MAIN_LIMIT}ãƒ»æ€ªç£ ${kCnt}/${MON_LIMIT}ï¼‰ã€‚ã“ã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)){
    return;
  }

  // åŒåãŒã‚ã‚Œã°ä¸Šæ›¸ãï¼ˆæœ€åˆã«ãƒ’ãƒƒãƒˆã—ãŸã‚‚ã®ï¼‰
  const sameName = decks.find(d=>String(d.name||'')===String(name));
  if(sameName){
    sameName.deck = cloneDeckObj(deck);
    sameName.updatedAt = now;
    activeDeckId = sameName.id;
    setDeckSaves(decks);
    alert('ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ');
    return;
  }

  // æ—¢ã«ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ‡ãƒƒã‚­ãŒã‚ã‚‹ãªã‚‰ã€ãã‚Œã‚’æ›´æ–°ã™ã‚‹ã‹æ–°è¦ã‹ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
  if(activeDeckId){
    const cur = decks.find(d=>d.id===activeDeckId);
    if(cur && confirm('ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ‡ãƒƒã‚­ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§æ–°è¦ä¿å­˜ï¼‰')){
      cur.name = name;
      cur.deck = cloneDeckObj(deck);
      cur.updatedAt = now;
      setDeckSaves(decks);
      alert('æ›´æ–°ä¿å­˜ã—ã¾ã—ãŸ');
      return;
    }
  }

  const entry = { id:newId(), name:String(name), deck:cloneDeckObj(deck), createdAt:now, updatedAt:now };
  decks.unshift(entry);
  activeDeckId = entry.id;
  setDeckSaves(decks);
  alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒƒã‚­ä¸€è¦§ã«è¿½åŠ ï¼‰');
}

function openDeckMgr(){
  deckMgr.classList.remove('hidden');
  deckMgrSearch.value = '';
  renderDeckMgr();
  setTimeout(()=>deckMgrSearch.focus(), 0);
}
function closeDeckMgr(){ deckMgr.classList.add('hidden'); }

function renderDeckMgr(){
  const q = (deckMgrSearch.value||'').trim().toLowerCase();
  const decks = getDeckSaves().slice().sort((a,b)=>{
    const ta = Date.parse(a.updatedAt||a.createdAt||0) || 0;
    const tb = Date.parse(b.updatedAt||b.createdAt||0) || 0;
    return tb-ta;
  });
  const filtered = q ? decks.filter(d=>String(d.name||'').toLowerCase().includes(q)) : decks;

  deckMgrList.innerHTML='';
  filtered.forEach(d=>{
    const div=document.createElement('div');
    div.className='deckItem';
    const mCnt = sumObj(d.deck?.main||{});
    const kCnt = sumObj(d.deck?.monster||{});
    const when = fmtJP(d.updatedAt||d.createdAt||'');
    div.innerHTML = `
      <div class="deckMeta">
        <div class="deckName">${escapeHtml(d.name||'(no name)')}</div>
        <div class="deckInfo">ãƒ¡ã‚¤ãƒ³ ${mCnt}/${MAIN_LIMIT} ãƒ» æ€ªç£ ${kCnt}/${MON_LIMIT}${when?(' ãƒ» æ›´æ–° '+when):''}</div>
      </div>
      <div class="deckActions">
        <button data-act="load" data-id="${escapeHtml(d.id)}">ãƒ­ãƒ¼ãƒ‰</button>
        <button data-act="rename" data-id="${escapeHtml(d.id)}">åå‰</button>
        <button data-act="delete" data-id="${escapeHtml(d.id)}">å‰Šé™¤</button>
      </div>
    `;
    deckMgrList.appendChild(div);
  });

  deckMgrCount.textContent = String(filtered.length);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function downloadDeckSaves(){
  const decks = getDeckSaves();
  const payload = { version: 1, exportedAt: new Date().toISOString(), decks };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  const ts = (()=>{const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;})();
  a.download = `go_deck_saves_${ts}.json`;
  a.href = URL.createObjectURL(blob);
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
}

function mergeDecks(existing, incoming){
  const byId = new Map();
  existing.forEach(d=>{ if(d && d.id) byId.set(d.id, d); });
  incoming.forEach(d=>{
    if(!d) return;
    if(!d.id) d.id = newId();
    if(!d.name) d.name = '(no name)';
    if(!d.deck) d.deck = {main:{}, monster:{}};
    const prev = byId.get(d.id);
    byId.set(d.id, Object.assign(prev||{}, d, { deck: cloneDeckObj(d.deck) }));
  });
  return Array.from(byId.values()).sort((a,b)=>{
    const ta = Date.parse(a.updatedAt||a.createdAt||0) || 0;
    const tb = Date.parse(b.updatedAt||b.createdAt||0) || 0;
    return tb-ta;
  });
}

async function importDeckSavesFile(file){
  const text = await file.text();
  const v = safeJSONParse(text, null);
  if(!v){ alert('ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒä¸æ­£ã§ã™'); return; }

  let incoming = null;
  if(Array.isArray(v)) incoming = v;
  else if(v && Array.isArray(v.decks)) incoming = v.decks;
  else incoming = null;

  if(!incoming){ alert('ã“ã®JSONã«ãƒ‡ãƒƒã‚­ä¸€è¦§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  const merged = mergeDecks(getDeckSaves(), incoming);
  setDeckSaves(merged);
  alert(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${incoming.length} ä»¶`);
  renderDeckMgr();
}

// wiring
btnDeckSave && (btnDeckSave.onclick = ()=>saveDeckPrompt());
btnDeckLoad && (btnDeckLoad.onclick = ()=>openDeckMgr());
btnDeckDownload && (btnDeckDownload.onclick = ()=>downloadDeckSaves());
btnDeckMgrClose && (btnDeckMgrClose.onclick = ()=>closeDeckMgr());
btnDeckMgrDownload && (btnDeckMgrDownload.onclick = ()=>downloadDeckSaves());
deckMgrSearch && deckMgrSearch.addEventListener('input', renderDeckMgr);

deckMgr && deckMgr.addEventListener('mousedown', (e)=>{ if(e.target===deckMgr) closeDeckMgr(); });
deckMgrList && deckMgrList.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]');
  if(!btn) return;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  const decks = getDeckSaves();
  const d = decks.find(x=>String(x.id)===String(id));
  if(act==='load'){
    if(!d){ alert('ãƒ‡ãƒƒã‚­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); renderDeckMgr(); return; }
    activeDeckId = d.id;
    applyDeckToBuilder(d.deck);
    closeDeckMgr();
    return;
  }
  if(act==='rename'){
    if(!d) return;
    const newName = prompt('æ–°ã—ã„ãƒ‡ãƒƒã‚­å', d.name||'');
    if(!newName) return;
    // åŒåãƒã‚§ãƒƒã‚¯ï¼ˆåˆ¥IDã®åŒåãŒã‚ã‚Œã°ä¸Šæ›¸ãã«ãªã‚‹ã®ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
    const conflict = decks.find(x=>x.id!==d.id && String(x.name||'')===String(newName));
    if(conflict && !confirm('åŒåã®ãƒ‡ãƒƒã‚­ãŒã‚ã‚Šã¾ã™ã€‚åå‰ã‚’ãã®ã¾ã¾å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')){
      return;
    }
    d.name = String(newName);
    d.updatedAt = new Date().toISOString();
    setDeckSaves(decks);
    renderDeckMgr();
    return;
  }
  if(act==='delete'){
    if(!d) return;
    if(!confirm(`ã€Œ${d.name||'(no name)'}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const next = decks.filter(x=>x.id!==d.id);
    setDeckSaves(next);
    if(activeDeckId===d.id) activeDeckId=null;
    renderDeckMgr();
  }
});

if(deckUploadInput){
  deckUploadInput.addEventListener('change', async (e)=>{
    const f = deckUploadInput.files && deckUploadInput.files[0];
    deckUploadInput.value = '';
    if(!f) return;
    try{
      await importDeckSavesFile(f);
    }catch(err){
      alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });
}


let libSetFilter='__ALL__'; // '__ALL__' = å…¨è¡¨ç¤º

function getAvailableSets(){
  const s = new Set(CARD_DB.map(c=>c.set).filter(x=>x && x!=='OTHER'));
  const baseOrder=['SD1','SD2','BP01','BP02','BP03','FC01'];
  const rest=[...s].filter(k=>!baseOrder.includes(k)).sort((a,b)=>a.localeCompare(b,'ja'));
  return [...baseOrder.filter(k=>s.has(k)), ...rest];
}

function updateSetBarActive(){
  if(!libSetBar) return;
  [...libSetBar.querySelectorAll('.setBtn')].forEach(btn=>{
    btn.classList.toggle('active', (btn.dataset.set||'')===libSetFilter);
  });
  if(libSetCurrent){
    libSetCurrent.textContent = (libSetFilter==='__ALL__') ? 'ã™ã¹ã¦' : (libSetFilter||'ã™ã¹ã¦');
  }
}


// collapsible set bar (deck builder)
function setSetBarCollapsed(collapsed){
  if(!libSetSection) return;
  libSetSection.classList.toggle('collapsed', !!collapsed);
  if(libSetHeader) libSetHeader.setAttribute('aria-expanded', (!collapsed).toString());
  try{ localStorage.setItem('libSetBarCollapsed', collapsed ? '1' : '0'); }catch(e){}
}
function loadSetBarCollapsed(){
  let v=null;
  try{ v = localStorage.getItem('libSetBarCollapsed'); }catch(e){}
  if(v===null) return; // default: expanded
  setSetBarCollapsed(v==='1');
}
if(btnLibSetToggle){
  btnLibSetToggle.addEventListener('click', (e)=>{ e.stopPropagation(); setSetBarCollapsed(!libSetSection.classList.contains('collapsed')); });
}
if(libSetHeader){
  libSetHeader.addEventListener('click', ()=>{ setSetBarCollapsed(!libSetSection.classList.contains('collapsed')); });
  libSetHeader.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' || e.key===' '){
      e.preventDefault();
      setSetBarCollapsed(!libSetSection.classList.contains('collapsed'));
    }
  });
}


function renderSetBar(){
  if(!libSetBar) return;
  libSetBar.innerHTML='';

  const makeBtn=(key,label,cls='')=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className=('setBtn '+(cls||'')).trim();
    btn.dataset.set=key;

    if(key!=='__ALL__'){
      const img=document.createElement('img');
      img.alt=label||key;
      img.loading='lazy';
      img.decoding='async';

      const tries=[];
      // æœŸå¾…ã™ã‚‹å‘½å: BP{æ®µæ•°}.png / SD{ç¨®é¡(1or2)}.png / FC01.pngï¼ˆ0åŸ‹ã‚é•ã„ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      tries.push(`${CARD_FOLDER}/${key}.png`);
      if(/^SD\d$/.test(key)) tries.push(`${CARD_FOLDER}/SD0${key.slice(2)}.png`);
      if(/^SD0\d$/.test(key)) tries.push(`${CARD_FOLDER}/SD${key.slice(3)}.png`);
      if(/^BP\d{2}$/.test(key)) tries.push(`${CARD_FOLDER}/BP${parseInt(key.slice(2),10)}.png`);
      if(/^BP\d$/.test(key)) tries.push(`${CARD_FOLDER}/BP0${key.slice(2)}.png`);
      if(/^FC\d{2}$/.test(key)) tries.push(`${CARD_FOLDER}/FC${parseInt(key.slice(2),10)}.png`);

      let i=0;
      const tryNext=()=>{
        if(i>=tries.length){
          img.remove();
          return;
        }
        img.src=tries[i++];
      };
      img.onerror=()=>{tryNext();};

      btn.appendChild(img);
      tryNext();
    }

    const span=document.createElement('span');
    span.className='setLabel';
    span.textContent=label||key;
    btn.appendChild(span);

    btn.addEventListener('click', ()=>{
      libSetFilter=key;
      updateSetBarActive();
      libList.scrollTop=0;
      renderLibrary();
    });
    return btn;
  };

  libSetBar.appendChild(makeBtn('__ALL__','ã™ã¹ã¦','all'));

  const sets=getAvailableSets();
  if(libSetFilter!=='__ALL__' && !sets.includes(libSetFilter)) libSetFilter='__ALL__';
  sets.forEach(k=>libSetBar.appendChild(makeBtn(k,k,'')));

  updateSetBarActive();
}

function openBuilder(){builder.classList.remove('hidden');renderSetBar();loadSetBarCollapsed();renderLibrary();renderDeckThumbs();updateBuildCount();}
function closeBuilder(){builder.classList.add('hidden');}

function renderLibrary(){
  libList.innerHTML='';
  const q=libFilter.value?libFilter.value.toLowerCase():'';
  const setKey=libSetFilter||'__ALL__';
  CARD_DB.forEach(card=>{
    if(setKey!=='__ALL__' && card.set!==setKey) return;
    if(q&&!card.name.toLowerCase().includes(q))return;
    const div=document.createElement('div');div.className='libCard';div.dataset.id=card.id;
    const img=document.createElement('img');img.src=card.srcGuess;img.onerror=()=>{img.src=WHITE_BACK;};div.appendChild(img);
    const btns=document.createElement('div');btns.className='libBtns';
    const bM=document.createElement('button');bM.textContent='ï¼‹ãƒ¡';bM.onclick=(e)=>{e.stopPropagation();addToBuild(card.id,'main',1);};
    const bK=document.createElement('button');bK.textContent='ï¼‹æ€ª';bK.onclick=(e)=>{e.stopPropagation();addToBuild(card.id,'monster',1);};
    btns.append(bM,bK);div.appendChild(btns);
    div.onclick=()=>{previewImg.src=card.srcGuess;preview.classList.remove('hidden');};
    libList.appendChild(div);
  });
}
libFilter.addEventListener('input',renderLibrary);

function addToBuild(id,which,count){const target=which==='monster'?buildMon:buildMain;target[id]=(target[id]||0)+count;renderDeckThumbs();updateBuildCount();}
function decFromBuild(id,which){const target=which==='monster'?buildMon:buildMain;if(!target[id])return;target[id]--;if(target[id]<=0)delete target[id];renderDeckThumbs();updateBuildCount();}
function renderDeckThumbs(){gridMonster.innerHTML='';gridMain.innerHTML='';const buildSection=(obj,grid,which)=>{Object.entries(obj).forEach(([id,num])=>{const info=CARD_DB.find(c=>c.id===id)||{srcGuess:WHITE_BACK,name:id};const wrap=document.createElement('div');wrap.className='deckThumb';const img=document.createElement('img');img.src=info.srcGuess;img.onerror=()=>{img.src=WHITE_BACK;};wrap.appendChild(img);const cnt=document.createElement('div');cnt.className='deckCnt';cnt.textContent='x'+num;wrap.appendChild(cnt);const ctrl=document.createElement('div');ctrl.className='ctrl';const plus=document.createElement('button');plus.textContent='ï¼‹';plus.onclick=()=>{addToBuild(id,which,1);};const minus=document.createElement('button');minus.textContent='ï¼';minus.onclick=()=>{decFromBuild(id,which);};ctrl.append(plus,minus);wrap.appendChild(ctrl);grid.appendChild(wrap);});};buildSection(buildMon,gridMonster,'monster');buildSection(buildMain,gridMain,'main');}
function updateBuildCount(){const m=sumObj(buildMain),k=sumObj(buildMon);countInfo.textContent=`ãƒ¡ã‚¤ãƒ³ ${m}/${MAIN_LIMIT}ã€€æ€ªç£ ${k}/${MON_LIMIT}`;btnBuildStart.disabled=!(m===MAIN_LIMIT&&k===MON_LIMIT);}
function sumObj(o){return Object.values(o).reduce((a,b)=>a+b,0);}
btnCodeGen.onclick=()=>{deckCodeBox.value=encodeDeck({main:buildMain,monster:buildMon});};
btnCodeLoad.onclick=()=>{try{const obj=decodeDeck(deckCodeBox.value.trim());buildMain=obj.main||{};buildMon=obj.monster||{};renderDeckThumbs();updateBuildCount();alert('èª­è¾¼å®Œäº†');}catch(e){alert('ã‚³ãƒ¼ãƒ‰ãŒä¸æ­£ã§ã™');}};
btnBuildCancel.onclick=()=>{closeBuilder();startModal.style.display='flex';};
btnBuildStart.onclick=()=>{if(!(sumObj(buildMain)===MAIN_LIMIT&&sumObj(buildMon)===MON_LIMIT)){alert('æšæ•°ãŒè¶³ã‚Šã¾ã›ã‚“');return;}closeBuilder();toolbar.classList.remove('hidden');applyDeckAndStart({main:buildMain,monster:buildMon});autoLoadBackImage();};
function encodeDeck(obj){return 'v1:'+btoa(unescape(encodeURIComponent(JSON.stringify(obj))))}
function decodeDeck(code){if(!code.startsWith('v1:'))throw new Error('ver');const json=decodeURIComponent(escape(atob(code.slice(3))));return JSON.parse(json);}
function applyDeckAndStart(obj){ // â†ã“ã“ã§æ€ªç£ãƒ‡ãƒƒã‚­é †ã‚’åè»¢
  Object.values(state.cards).forEach(c=>{const el=document.getElementById(c.id);if(el)el.remove();});
  state.cards={};state.order=[];deckPool=[];discardPool=[];monsterPool=[];selection.clear();Object.keys(dupCountByName).forEach(k=>delete dupCountByName[k]);idCounter=0;rageCount=0;updateRageDisplay();
  // ãƒ¡ã‚¤ãƒ³ã¯é€šå¸¸é †
  Object.entries(obj.main).forEach(([id,count])=>{
    const info=CARD_DB.find(c=>c.id===id)||{name:id,srcGuess:WHITE_BACK};
    for(let i=0;i<count;i++){
      const c=spawnCard(info.srcGuess,{zone:'deckMain',faceDown:true,origName:info.name});
      deckPool.push(c.id);hideIfPooled(c);
    }
  });
  // æ€ªç£ã¯åè»¢ã—ã¦è¿½åŠ ï¼ˆå·¦å´ï¼æœ€åˆã®è¦ç´ ãŒæœ€å¾Œã«ç”Ÿæˆâ†’æœ€å‰é¢ï¼‰
  Object.entries(obj.monster).reverse().forEach(([id,count])=>{
    const info=CARD_DB.find(c=>c.id===id)||{name:id,srcGuess:WHITE_BACK};
    for(let i=0;i<count;i++){
      const c=spawnCard(info.srcGuess,{zone:'monster',faceDown:true,origName:info.name});
      monsterPool.push(c.id);hideIfPooled(c);
    }
  });
  shuffleDeck();updateCounters();pushUndo();
}

// smoke
(function(){try{console.assert(typeof bringToBack==='function');console.assert(typeof encodeDeck==='function');console.log('%cSmoke OK','color:#0f0');}catch(e){console.error(e);}})();

pushUndo();updateCounters();updateRageDisplay();

// ===== Action Log v1 =====
(function(){
  const LOG_KEY = 'go_action_log_v1';
  const MAX_LOG = 500;
  let actionLog = [];

  const elLog = document.getElementById('log');
  const elLogList = document.getElementById('logList');
  const elLogSearch = document.getElementById('logSearch');
  const btnLog = document.getElementById('btnLog');
  const btnLogClose = document.getElementById('btnLogClose');
  const btnLogCopy = document.getElementById('btnLogCopy');
  const btnLogClear = document.getElementById('btnLogClear');

  function safeParse(json, fallback){
    try{ const v = JSON.parse(json); return v ?? fallback; }catch(e){ return fallback; }
  }
  function loadLog(){
    actionLog = safeParse(localStorage.getItem(LOG_KEY) || '[]', []);
    if(!Array.isArray(actionLog)) actionLog = [];
  }
  function saveLog(){
    try{ localStorage.setItem(LOG_KEY, JSON.stringify(actionLog.slice(-MAX_LOG))); }catch(e){}
  }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmtTime(iso){
    try{
      const d = new Date(iso);
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }catch(e){ return '--:--:--'; }
  }
  function zoneLabel(zoneId){
    if(zoneId==='hand') return 'æ‰‹æœ­';
    if(zoneId==='deckMain') return 'å±±æœ­';
    if(zoneId==='discard') return 'æ¨ã¦æœ­';
    if(zoneId==='monster') return 'æ€ªç£';
    const z = (typeof zones!=='undefined' && Array.isArray(zones)) ? zones.find(z=>z.id===zoneId) : null;
    return z ? z.name : String(zoneId||'');
  }
  function cardLabelById(id){
    const c = state && state.cards ? state.cards[id] : null;
    if(!c) return String(id);
    return c.origName || c.name || c.id || String(id);
  }

  function logAction(msg){
    if(!msg) return;
    const entry = { t: new Date().toISOString(), msg: String(msg) };
    actionLog.push(entry);
    if(actionLog.length > MAX_LOG) actionLog.shift();
    saveLog();
    if(!elLog.classList.contains('hidden')) renderLog();
  }
  // expose for debugging
  window.logAction = logAction;

  function renderLog(){
    if(!elLogList) return;
    const q = (elLogSearch?.value || '').trim().toLowerCase();
    const lines = [];
    for(const e of actionLog){
      const line = `[${fmtTime(e.t)}] ${e.msg}`;
      if(!q || line.toLowerCase().includes(q)) lines.push(line);
    }
    elLogList.textContent = lines.join('\n');
    // scroll to bottom
    elLogList.scrollTop = elLogList.scrollHeight;
  }

  function openLog(){
    if(!elLog) return;
    elLog.classList.remove('hidden');
    renderLog();
    try{ elLogSearch?.focus(); }catch(e){}
  }
  function closeLog(){
    if(!elLog) return;
    elLog.classList.add('hidden');
  }

  // UI wiring
  if(btnLog) btnLog.onclick = openLog;
  if(btnLogClose) btnLogClose.onclick = closeLog;
  if(elLog) elLog.addEventListener('click', (e)=>{ if(e.target===elLog) closeLog(); });
  if(elLogSearch) elLogSearch.addEventListener('input', renderLog);
  document.addEventListener('keydown', (e)=>{
    if(elLog && !elLog.classList.contains('hidden') && e.key==='Escape'){
      e.preventDefault(); closeLog();
    }
  });

  if(btnLogCopy) btnLogCopy.onclick = async ()=>{
    const text = elLogList?.textContent || '';
    if(!text){ alert('ãƒ­ã‚°ãŒç©ºã§ã™'); return; }
    try{
      await navigator.clipboard.writeText(text);
      alert('ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }catch(err){
      // fallback
      const ta=document.createElement('textarea');
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      ta.remove();
      alert('ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }
  };

  if(btnLogClear) btnLogClear.onclick = ()=>{
    if(!confirm('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆç›¤é¢ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰')) return;
    actionLog = [];
    saveLog();
    renderLog();
  };

  // initial load
  loadLog();

  // --------- Patch / hook major actions ----------
  // Flip
  if(typeof btnFlip!=='undefined' && btnFlip && typeof btnFlip.onclick==='function'){
    const _flip = btnFlip.onclick;
    btnFlip.onclick = ()=>{
      // count eligible before
      let n=0;
      selection?.forEach?.(id=>{
        const c=state.cards[id]; if(!c) return;
        if(c.zone==='deckMain' || c.zone==='discard') return;
        n++;
      });
      _flip();
      if(n>0) logAction(`è¡¨è£åè»¢ï¼š${n}æš`);
    };
  }

  // Remove
  if(typeof btnRemove!=='undefined' && btnRemove && typeof btnRemove.onclick==='function'){
    const _rm = btnRemove.onclick;
    btnRemove.onclick = ()=>{
      const ids = Array.from(selection||[]);
      const n = ids.length;
      const preview = ids.slice(0,3).map(cardLabelById).join(' / ');
      _rm();
      if(n>0) logAction(`æ¶ˆæ»…ï¼š${n}æš${preview?`ï¼ˆ${preview}${n>3?'...':''}ï¼‰`:''}`);
    };
  }

  // Front/Back ordering buttons
  if(typeof btnToFront!=='undefined' && btnToFront && typeof btnToFront.onclick==='function'){
    const _f = btnToFront.onclick;
    btnToFront.onclick = ()=>{ const n=(selection?.size||0); _f(); if(n>0) logAction(`æœ€å‰é¢ï¼š${n}æš`); };
  }
  if(typeof btnToBack!=='undefined' && btnToBack && typeof btnToBack.onclick==='function'){
    const _b = btnToBack.onclick;
    btnToBack.onclick = ()=>{ const n=(selection?.size||0); _b(); if(n>0) logAction(`æœ€å¾Œé¢ï¼š${n}æš`); };
  }

  // Undo function
  if(typeof undo==='function'){
    const _undo = undo;
    window.undo = function(){
      const before = state.undoStack?.length||0;
      _undo();
      const after = state.undoStack?.length||0;
      if(after < before) logAction('Undo');
    };
  }

  // Save / Load
  if(typeof saveLocal==='function'){
    const _save = saveLocal;
    window.saveLocal = function(){
      _save();
      logAction('ä¿å­˜');
    };
  }
  if(typeof loadLocal==='function'){
    const _load = loadLocal;
    window.loadLocal = function(){
      _load();
      logAction('èª­è¾¼');
    };
  }

  // Turn start
  if(typeof turnStart==='function'){
    const _ts = turnStart;
    window.turnStart = function(){
      _ts();
      logAction('ã‚¿ãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ');
    };
  }

  // Draw / Shuffle
  if(typeof drawFromDeck==='function'){
    const _draw = drawFromDeck;
    window.drawFromDeck = function(n){
      const before = deckPool?.length||0;
      const actual = Math.min(Number(n)||0, before);
      _draw(n);
      if(actual>0) logAction(`å±±æœ­â†’æ‰‹æœ­ï¼š${actual}æšãƒ‰ãƒ­ãƒ¼ï¼ˆæ®‹ã‚Š${deckPool.length}ï¼‰`);
    };
  }
  if(typeof shuffleDeck==='function'){
    const _sh = shuffleDeck;
    window.shuffleDeck = function(){
      _sh();
      logAction(`å±±æœ­ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆ${deckPool.length}æšï¼‰`);
    };
  }

  // Viewer (Search)
  if(typeof openViewer==='function'){
    const _ov = openViewer;
    window.openViewer = function(mode){
      _ov(mode);
      logAction(`ã‚µãƒ¼ãƒï¼š${mode==='discard'?'æ¨ã¦æœ­':(mode==='deck'?'å±±æœ­':String(mode))}`);
    };
  }
  if(typeof viewerMoveToHand==='function'){
    const _m = viewerMoveToHand;
    window.viewerMoveToHand = function(){
      const n = viewerSelection?.size||0;
      const from = viewerMode==='discard' ? 'æ¨ã¦æœ­' : 'å±±æœ­';
      _m();
      if(n>0) logAction(`ã‚µãƒ¼ãƒâ†’æ‰‹æœ­ï¼š${n}æšï¼ˆfrom ${from}ï¼‰`);
    };
  }
  if(typeof viewerMoveToDiscard==='function'){
    const _m = viewerMoveToDiscard;
    window.viewerMoveToDiscard = function(){
      const n = viewerSelection?.size||0;
      const from = viewerMode==='discard' ? 'æ¨ã¦æœ­' : 'å±±æœ­';
      _m();
      if(n>0) logAction(`ã‚µãƒ¼ãƒâ†’æ¨ã¦æœ­ï¼š${n}æšï¼ˆfrom ${from}ï¼‰`);
    };
  }

  // Reveal
  if(typeof startReveal==='function'){
    const _sr = startReveal;
    window.startReveal = function(n){
      _sr(n);
      logAction(`å…¬é–‹ï¼šå±±æœ­ä¸Šã‹ã‚‰${n}æš`);
    };
  }
  if(typeof cancelReveal==='function'){
    const _cr = cancelReveal;
    window.cancelReveal = function(){
      const wasOpen = (typeof revealPool!=='undefined' && revealPool && revealPool.length) ? revealPool.length : 0;
      _cr();
      if(wasOpen) logAction('å…¬é–‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    };
  }
  if(typeof revealMoveSelectedToHand==='function'){
    const _r = revealMoveSelectedToHand;
    window.revealMoveSelectedToHand = function(){
      const n = revealSelection?.size||0;
      _r();
      if(n>0) logAction(`å…¬é–‹â†’æ‰‹æœ­ï¼š${n}æš`);
    };
  }
  if(typeof revealMoveSelectedToDiscard==='function'){
    const _r = revealMoveSelectedToDiscard;
    window.revealMoveSelectedToDiscard = function(){
      const n = revealSelection?.size||0;
      _r();
      if(n>0) logAction(`å…¬é–‹â†’æ¨ã¦æœ­ï¼š${n}æš`);
    };
  }
  if(typeof returnRevealToDeck==='function'){
    const _r = returnRevealToDeck;
    window.returnRevealToDeck = function(){
      const n = revealPool?.length||0;
      _r();
      if(n>0) logAction(`å…¬é–‹â†’å±±æœ­ã¸æˆ»ã™ï¼š${n}æšï¼ˆé †ç•ªåæ˜ ï¼‰`);
    };
  }

  // Move via drag/drop
  if(typeof moveSelectionToZone==='function'){
    const _mv = moveSelectionToZone;
    window.moveSelectionToZone = function(zoneId){
      const ids = Array.from(selection||[]);
      const beforeZones = new Map();
      ids.forEach(id=>{
        const c=state.cards[id];
        if(c) beforeZones.set(id, c.zone);
      });
      _mv(zoneId);
      // count actually moved
      let moved=0;
      const fromSet=new Set();
      ids.forEach(id=>{
        const c=state.cards[id];
        const before=beforeZones.get(id);
        if(c && before && c.zone!==before){
          moved++;
          fromSet.add(zoneLabel(before));
        }
      });
      if(moved>0){
        const from = Array.from(fromSet).join(',');
        logAction(`ç§»å‹•ï¼š${moved}æšï¼ˆ${from} â†’ ${zoneLabel(zoneId)}ï¼‰`);
      }
    };
  }

  // Tokens
  if(typeof spawnTokens==='function'){
    const _st = spawnTokens;
    window.spawnTokens = function(src, origName, count){
      _st(src, origName, count);
      if(count>0) logAction(`ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼š${origName||'token'} Ã—${count}`);
    };
  }

  // A small greeting for the session (only once per page load)
  logAction('ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰');
})();


// [spectator-sync] çŠ¶æ…‹èª­ã¿è¾¼ã¿å¾Œã‚‚åŒæœŸ
let __wrapLoadFromJSON=false;try{if(!__wrapLoadFromJSON){const __loadFromJSON=loadFromJSON;loadFromJSON=(json,push=true)=>{__loadFromJSON(json,push);sendStateToSpectator();};__wrapLoadFromJSON=true;}}catch(e){}

// [spectator-sync] Undoç©ã¿å¾Œã‚‚åŒæœŸ
let __wrapPushUndo=false;try{if(!__wrapPushUndo){const __pushUndo=pushUndo;pushUndo=()=>{__pushUndo();sendStateToSpectator();};__wrapPushUndo=true;}}catch(e){}


// ===== Mobile quick bar handlers =====
(function(){
  const mbMenu = document.getElementById('mbMenu');
  const mbTop  = document.getElementById('mbTop');
  const mbField= document.getElementById('mbField');
  const mbHand = document.getElementById('mbHand');
  const mbUndo = document.getElementById('mbUndo');
  const mbFlip = document.getElementById('mbFlip');
  const mbVanish = document.getElementById('mbVanish');

  const scrollToZone = (zid)=>{
    const z = zones.find(z=>z.id===zid);
    if(!z) return;
    window.scrollTo({ top: Math.max(0, z.y - 8), behavior: 'smooth' });
  };

  if(mbMenu) mbMenu.onclick = ()=>{
    toolbar.classList.toggle('hidden');
  };
  if(mbTop)  mbTop.onclick  = ()=>scrollToZone('strategy1');
  if(mbField)mbField.onclick= ()=>scrollToZone('slot6');
  if(mbHand) mbHand.onclick = ()=>scrollToZone('hand');

  if(mbUndo) mbUndo.onclick = ()=>undo();
  if(mbFlip) mbFlip.onclick = ()=>btnFlip.click();
  if(mbVanish) mbVanish.onclick = ()=>btnVanish.click();
})();

</script>

<!-- ===== Mobile quick bar ===== -->
<div id="mobileBar" class="mobileBar">
  <button id="mbMenu">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  <button id="mbTop">ä¸Š</button>
  <button id="mbField">ç›¤é¢</button>
  <button id="mbHand">æ‰‹æœ­</button>
  <span class="spacer"></span>
  <button id="mbUndo">Undo</button>
  <button id="mbFlip">è¡¨è£</button>
  <button id="mbVanish">æ¶ˆæ»…</button>
</div>

</body>
</html>